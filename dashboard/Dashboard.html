<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUSE Loyalty Analytics Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* Colors - Modern Premium Palette */
            --navy: #1B365D;
            --navy-dark: #0F1D35;
            --navy-light: #2A4A7A;
            --steel-blue: #3B82F6;
            --steel-blue-light: #60A5FA;
            --light-steel: #DBEAFE;
            --gold: #D4AF37;
            --gold-light: #F4E4B0;
            --positive: #10B981;
            --positive-light: #D1FAE5;
            --positive-dark: #059669;
            --negative: #EF4444;
            --negative-light: #FEE2E2;
            --negative-dark: #DC2626;
            --warning: #F59E0B;
            --warning-light: #FEF3C7;
            --warning-dark: #D97706;
            --neutral: #6B7280;
            --neutral-light: #F3F4F6;
            --positive-soft: #34D399;
            --negative-soft: #F87171;
            --neutral-soft: #FBBF24;
            --white: #FFFFFF;
            --light-bg: #F8FAFC;
            --card-bg: #FFFFFF;
            --section-bg: #F1F5F9;
            --light-bg-gradient: linear-gradient(135deg, #F8FAFC 0%, #EEF2FF 100%);
            --text-dark: #1B365D;
            --text-primary: #1E293B;
            --text-secondary: #475569;
            --text-muted: #64748B;
            --text-light: #94A3B8;
            --border-light: #E2E8F0;
            --border-medium: #CBD5E1;
            --shadow-sm: 0 1px 2px rgba(27, 54, 93, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(27, 54, 93, 0.1), 0 2px 4px -1px rgba(27, 54, 93, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(27, 54, 93, 0.1), 0 4px 6px -2px rgba(27, 54, 93, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(27, 54, 93, 0.1), 0 10px 10px -5px rgba(27, 54, 93, 0.04);
            --shadow-card: 0 2px 8px rgba(27, 54, 93, 0.08);
            --shadow-glow-positive: 0 0 20px rgba(16, 185, 129, 0.3);
            --shadow-glow-negative: 0 0 20px rgba(239, 68, 68, 0.3);

            /* Typography Scale */
            --font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --font-display: 56px;
            --font-h1: 28px;
            --font-h2: 24px;
            --font-h3: 20px;
            --font-value-xl: 36px;
            --font-value-lg: 28px;
            --font-value-md: 24px;
            --font-value-sm: 17px;
            --font-body-lg: 16px;
            --font-body: 15px;
            --font-body-sm: 14px;
            --font-small: 13px;
            --font-caption: 13px;
            --font-label: 12px;
            --font-micro: 11px;

            /* Font Weights */
            --weight-normal: 400;
            --weight-medium: 500;
            --weight-semibold: 600;
            --weight-bold: 700;

            /* Line Heights */
            --line-height-tight: 1.2;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.75;

            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
            --space-3xl: 64px;

            /* Borders & Radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;
            --border-width: 1px;

            /* Animation Timing */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 350ms ease;
            --transition-bounce: 400ms cubic-bezier(0.34, 1.56, 0.64, 1);

            /* Z-Index Layers */
            --z-base: 1;
            --z-dropdown: 100;
            --z-sticky: 200;
            --z-modal: 300;
            --z-tooltip: 400;
        }

        body {
            font-family: var(--font-family);
            background: var(--light-bg-gradient);
            background-attachment: fixed;
            color: var(--text-dark);
            line-height: var(--line-height-normal);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Google Font Import */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        /* Animation Keyframes */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes drawLine {
            to { stroke-dashoffset: 0; }
        }

        .animate-fade-in { animation: fadeIn var(--transition-slow) ease forwards; }
        .animate-fade-in-up { animation: fadeInUp var(--transition-slow) ease forwards; }
        .animate-slide-in { animation: slideInRight var(--transition-slow) ease forwards; }
        .animate-scale-in { animation: scaleIn var(--transition-bounce) forwards; }

        /* Staggered Animation Classes */
        .stagger-1 { animation-delay: 50ms; }
        .stagger-2 { animation-delay: 100ms; }
        .stagger-3 { animation-delay: 150ms; }
        .stagger-4 { animation-delay: 200ms; }
        .stagger-5 { animation-delay: 250ms; }
        .stagger-6 { animation-delay: 300ms; }

        /* Header */
        .header {
            background: var(--white);
            padding: 20px 48px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-md);
            position: relative;
            z-index: 50;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--navy) 0%, var(--steel-blue) 50%, var(--navy) 100%);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .logo-container {
            background: var(--white);
            padding: 8px;
        }

        .logo-container img {
            height: 60px;
            width: auto;
            max-width: 200px;
            object-fit: contain;
        }

        .header-text h1 {
            font-size: var(--font-h1);
            font-weight: var(--weight-bold);
            color: var(--navy);
        }

        .header-text p {
            color: var(--text-muted);
            font-size: var(--font-body);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
        }

        /* Mode Toggle (C-Overview / M-Depth) */
        .mode-toggle {
            display: flex;
            background: var(--light-bg);
            border-radius: var(--radius-full);
            padding: 4px;
            border: 1px solid var(--border-light);
        }

        .mode-toggle-btn {
            padding: 10px 24px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: var(--font-body-sm);
            font-weight: var(--weight-semibold);
            cursor: pointer;
            border-radius: var(--radius-full);
            transition: all var(--transition-normal);
        }

        .mode-toggle-btn:hover {
            color: var(--navy);
        }

        .mode-toggle-btn.active {
            background: var(--navy);
            color: var(--white);
            box-shadow: var(--shadow-sm);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 4px;
            padding: 0 48px;
            background: var(--white);
            border-bottom: 1px solid var(--light-steel);
            position: sticky;
            top: 0;
            z-index: 40;
            box-shadow: var(--shadow-sm);
        }

        .tab-btn {
            padding: 16px 28px;
            color: var(--text-muted);
            font-size: var(--font-body);
            font-weight: var(--weight-medium);
            cursor: pointer;
            border: none;
            background: transparent;
            border-bottom: 3px solid transparent;
            transition: all var(--transition-normal);
            position: relative;
        }

        .tab-btn:hover {
            color: var(--navy);
            background: var(--light-bg);
        }

        .tab-btn.active {
            color: var(--navy);
            border-bottom-color: var(--steel-blue);
            font-weight: var(--weight-semibold);
            background: linear-gradient(180deg, transparent 0%, rgba(59, 130, 246, 0.05) 100%);
        }

        /* Main Content */
        .main {
            padding: 32px 48px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Filter Row */
        .filter-row {
            display: flex;
            gap: 20px;
            margin-bottom: 28px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .filter-group label {
            font-size: var(--font-label);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: var(--weight-semibold);
        }

        .filter-select {
            background: var(--white);
            border: 2px solid var(--light-steel);
            color: var(--navy);
            padding: 14px 48px 14px 18px;
            border-radius: var(--radius-md);
            font-size: var(--font-body);
            font-weight: var(--weight-semibold);
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%231B365D' viewBox='0 0 16 16'%3E%3Cpath d='M8 12L2 6h12l-6 6z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            min-width: 200px;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }

        .filter-select:hover {
            border-color: var(--steel-blue);
            box-shadow: var(--shadow-md);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--steel-blue);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--light-steel);
        }

        .section-title {
            font-size: var(--font-h2);
            font-weight: var(--weight-bold);
            color: var(--navy);
            letter-spacing: -0.3px;
            position: relative;
            padding-left: 16px;
        }

        .section-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background: linear-gradient(180deg, var(--steel-blue) 0%, var(--navy) 100%);
            border-radius: 2px;
        }

        .section-subtitle {
            color: var(--text-muted);
            font-size: var(--font-body);
        }

        /* Hero Cards */
        .hero-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .hero-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            border: 1px solid rgba(219, 234, 254, 0.8);
            border-top: 4px solid var(--navy);
            box-shadow: var(--shadow-card);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .hero-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--navy) 0%, var(--steel-blue) 100%);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .hero-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: transparent;
        }

        .hero-card:hover::before {
            opacity: 1;
        }

        .hero-card.card-positive {
            border-top-color: var(--positive);
        }

        .hero-card.card-positive::before {
            background: linear-gradient(90deg, var(--positive) 0%, var(--positive-light) 100%);
        }

        .hero-card.card-negative {
            border-top-color: var(--negative);
        }

        .hero-card.card-negative::before {
            background: linear-gradient(90deg, var(--negative) 0%, var(--negative-light) 100%);
        }

        .hero-card.card-neutral {
            border-top-color: var(--neutral);
        }

        .hero-card-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
        }

        .hero-card-icon {
            color: var(--steel-blue);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hero-card-icon svg {
            width: 20px;
            height: 20px;
        }

        .hero-card-label {
            font-size: var(--font-label);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: var(--weight-semibold);
        }

        .hero-card-value {
            font-size: var(--font-value-xl);
            font-weight: 800;
            color: var(--navy);
            margin-bottom: var(--space-md);
            letter-spacing: -1px;
            font-variant-numeric: tabular-nums;
        }

        .hero-card-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: 6px 14px;
            border-radius: var(--radius-full);
            font-weight: var(--weight-bold);
            font-size: var(--font-body-sm);
            transition: all var(--transition-fast);
        }

        .hero-card-badge.positive {
            background: linear-gradient(135deg, var(--positive-light) 0%, rgba(16, 185, 129, 0.2) 100%);
            color: var(--positive-dark);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }

        .hero-card-badge.negative {
            background: linear-gradient(135deg, var(--negative-light) 0%, rgba(239, 68, 68, 0.2) 100%);
            color: var(--negative-dark);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
        }

        .hero-card-badge.neutral {
            background: var(--neutral-light);
            color: var(--text-muted);
        }

        .hero-card-secondary {
            margin-top: var(--space-sm);
            font-size: var(--font-caption);
            color: var(--text-muted);
        }

        .hero-card-target {
            margin-top: var(--space-md);
            padding-top: var(--space-sm);
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-small);
        }

        .target-label {
            color: var(--text-muted);
        }

        .target-value {
            font-weight: var(--weight-semibold);
            color: var(--navy);
        }

        /* KPI Table */
        .kpi-table {
            width: 100%;
            background: var(--white);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border-collapse: separate;
            border-spacing: 0;
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-xl);
        }

        .kpi-table th {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            padding: 18px 20px;
            text-align: center;
            font-size: var(--font-caption);
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: var(--weight-semibold);
        }

        .kpi-table th:first-child {
            text-align: left;
        }

        .kpi-table td {
            padding: 18px 20px;
            border-bottom: 1px solid rgba(219, 234, 254, 0.5);
            font-size: var(--font-body);
            text-align: center;
            transition: background var(--transition-fast);
        }

        .kpi-table tr:hover td {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.05) 0%, transparent 100%);
        }

        .kpi-name {
            font-weight: var(--weight-semibold);
            color: var(--navy);
            text-align: left !important;
        }

        .kpi-value {
            font-weight: var(--weight-bold);
            color: var(--navy);
        }

        .kpi-change {
            font-weight: var(--weight-semibold);
        }

        .kpi-change.positive { color: var(--positive); }
        .kpi-change.negative { color: var(--negative); }
        .kpi-change.neutral { color: var(--text-muted); }

        .kpi-row.row-positive { background: rgba(16, 185, 129, 0.05); }
        .kpi-row.row-warning { background: rgba(245, 158, 11, 0.05); }
        .kpi-row.row-negative { background: rgba(239, 68, 68, 0.05); }

        /* Insights Panel */
        .insights-panel {
            background: linear-gradient(135deg, var(--white) 0%, rgba(219, 234, 254, 0.3) 100%);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            border: 1px solid rgba(219, 234, 254, 0.8);
            border-left: 5px solid var(--steel-blue);
            margin-bottom: var(--space-xl);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .insights-panel::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.05) 0%, transparent 70%);
            pointer-events: none;
        }

        .insights-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .insights-title {
            font-size: var(--font-h3);
            font-weight: var(--weight-bold);
            color: var(--navy);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .insights-toggle {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            background: rgba(59, 130, 246, 0.1);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-normal);
            color: var(--steel-blue);
        }

        .insights-toggle:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        .insights-toggle svg {
            transition: transform var(--transition-normal);
        }

        .insights-panel.collapsed .insights-toggle svg {
            transform: rotate(-90deg);
        }

        .insights-content {
            margin-top: var(--space-lg);
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 1000px;
            opacity: 1;
        }

        .insights-panel.collapsed .insights-content {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }

        .insight-row {
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
            padding: var(--space-md);
            background: var(--white);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-sm);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-normal);
        }

        .insight-row:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }

        .insight-row.insight-critical {
            border-left: 3px solid var(--negative);
        }

        .insight-row.insight-warning {
            border-left: 3px solid var(--warning);
        }

        .insight-row.insight-positive {
            border-left: 3px solid var(--positive);
        }

        .insight-row.insight-info {
            border-left: 3px solid var(--steel-blue);
        }

        .insight-icon {
            font-size: var(--font-body-lg);
            flex-shrink: 0;
        }

        .insight-text {
            font-size: var(--font-body);
            color: var(--text-dark);
            line-height: var(--line-height-normal);
        }

        .insights-empty {
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
            padding: var(--space-lg);
        }

        /* Market Comparison Bars */
        .market-bars {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .market-bar-row {
            display: grid;
            grid-template-columns: 150px 1fr 100px 100px;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            background: var(--white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-normal);
        }

        .market-bar-row:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }

        .market-bar-value {
            font-weight: var(--weight-bold);
            color: var(--navy);
            text-align: right;
        }

        .market-bar-label {
            font-weight: var(--weight-semibold);
            color: var(--navy);
        }

        .market-bar-container {
            height: 24px;
            background: var(--neutral-light);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .market-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--navy) 0%, var(--steel-blue) 100%);
            border-radius: var(--radius-sm);
            transition: width var(--transition-slow);
        }

        .market-bar-badge {
            font-weight: var(--weight-semibold);
            font-size: var(--font-caption);
            padding: 4px 10px;
            border-radius: var(--radius-full);
        }

        .market-bar-badge.positive {
            background: var(--positive-light);
            color: var(--positive-dark);
        }

        .market-bar-badge.negative {
            background: var(--negative-light);
            color: var(--negative-dark);
        }

        .market-bar-badge.neutral {
            background: var(--neutral-light);
            color: var(--text-muted);
        }

        /* Heatmap */
        .heatmap {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-xl);
            overflow-x: auto;
        }

        .heatmap-title {
            font-size: var(--font-h3);
            font-weight: var(--weight-bold);
            color: var(--navy);
            margin-bottom: var(--space-lg);
        }

        .heatmap-grid {
            display: grid;
            gap: var(--space-xs);
        }

        .heatmap-row {
            display: flex;
            gap: var(--space-xs);
        }

        .heatmap-header {
            width: 150px;
            padding: var(--space-sm);
            font-weight: var(--weight-semibold);
            color: var(--navy);
            display: flex;
            align-items: center;
        }

        .heatmap-cell {
            width: 80px;
            height: 48px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--weight-semibold);
            font-size: var(--font-caption);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .heatmap-cell:hover {
            transform: scale(1.05);
        }

        .heatmap-positive {
            background: var(--positive-light);
            color: var(--positive-dark);
        }

        .heatmap-warning {
            background: var(--warning-light);
            color: var(--warning-dark);
        }

        .heatmap-negative {
            background: var(--negative-light);
            color: var(--negative-dark);
        }

        .heatmap-neutral {
            background: var(--neutral-light);
            color: var(--text-muted);
        }

        .heatmap-header-cell {
            background: var(--navy);
            color: white;
            font-size: 10px;
            font-weight: var(--weight-semibold);
        }

        .heatmap-legend {
            display: flex;
            gap: var(--space-lg);
            margin-bottom: var(--space-md);
            font-size: var(--font-caption);
            color: var(--text-muted);
        }

        .heatmap-legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .heatmap-dot {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .heatmap-dot.heatmap-positive {
            background: var(--positive-light);
            border: 1px solid var(--positive);
        }

        .heatmap-dot.heatmap-warning {
            background: var(--warning-light);
            border: 1px solid var(--warning);
        }

        .heatmap-dot.heatmap-negative {
            background: var(--negative-light);
            border: 1px solid var(--negative);
        }

        /* Trend Chart */
        .trend-chart {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-xl);
        }

        .trend-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
        }

        .trend-chart-title {
            font-size: var(--font-h3);
            font-weight: var(--weight-bold);
            color: var(--navy);
        }

        .trend-legend {
            display: flex;
            gap: var(--space-lg);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: var(--font-caption);
            color: var(--text-muted);
        }

        .legend-dot {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        .legend-dot.current { background: var(--navy); }
        .legend-dot.lastyear { background: var(--text-muted); }
        .legend-dot.target { background: var(--positive); }

        .legend-line {
            width: 24px;
            height: 3px;
            border-radius: 2px;
            position: relative;
        }

        .legend-line.current {
            background: var(--steel-blue);
        }

        .legend-line.lastyear {
            background: repeating-linear-gradient(
                90deg,
                var(--text-muted) 0px,
                var(--text-muted) 8px,
                transparent 8px,
                transparent 12px
            );
        }

        .legend-line.target {
            background: repeating-linear-gradient(
                90deg,
                var(--navy) 0px,
                var(--navy) 4px,
                transparent 4px,
                transparent 8px
            );
        }

        .chart-svg {
            width: 100%;
            height: 300px;
        }

        .chart-dot {
            cursor: pointer;
            transition: r var(--transition-fast);
        }

        .chart-dot:hover {
            r: 8;
        }

        /* Chart Tooltip */
        .chart-tooltip {
            position: fixed;
            background: var(--navy);
            color: var(--white);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            font-size: var(--font-caption);
            pointer-events: none;
            opacity: 0;
            transition: opacity var(--transition-fast);
            z-index: var(--z-tooltip);
            box-shadow: var(--shadow-lg);
        }

        .chart-tooltip.visible {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: var(--weight-bold);
            margin-bottom: var(--space-sm);
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: var(--space-md);
        }

        .tooltip-label {
            color: var(--text-light);
        }

        .tooltip-value {
            font-weight: var(--weight-semibold);
        }

        .tooltip-change {
            font-size: var(--font-micro);
            margin-left: var(--space-xs);
        }

        .tooltip-change.positive {
            color: var(--positive-light);
        }

        .tooltip-change.negative {
            color: var(--negative-light);
        }

        /* Upload Screen */
        .upload-overlay {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-xl);
        }

        .upload-box {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            max-width: 600px;
            width: 100%;
            box-shadow: var(--shadow-xl);
            text-align: center;
        }

        .upload-logo {
            margin-bottom: var(--space-lg);
        }

        .upload-logo img {
            height: 80px;
            width: auto;
        }

        .upload-box h2 {
            font-size: var(--font-h2);
            color: var(--navy);
            margin-bottom: var(--space-sm);
        }

        .upload-box > p {
            color: var(--text-muted);
            margin-bottom: var(--space-xl);
        }

        .upload-zone {
            border: 2px dashed var(--border-medium);
            border-radius: var(--radius-lg);
            padding: var(--space-2xl);
            margin-bottom: var(--space-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .upload-zone:hover {
            border-color: var(--steel-blue);
            background: rgba(59, 130, 246, 0.05);
        }

        .upload-zone-icon {
            font-size: 48px;
            margin-bottom: var(--space-md);
        }

        .upload-zone-text {
            color: var(--text-muted);
        }

        .upload-zone-file {
            color: var(--positive);
            font-weight: var(--weight-semibold);
        }

        .upload-hint {
            font-size: var(--font-caption);
            color: var(--text-muted);
            margin-bottom: var(--space-lg);
        }

        /* Multi-file Upload */
        .upload-files-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .upload-file-card {
            border: 2px dashed var(--border-medium);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            text-align: center;
        }

        .upload-file-card:hover {
            border-color: var(--steel-blue);
            background: rgba(59, 130, 246, 0.05);
        }

        .upload-file-card.loaded {
            border-color: var(--positive);
            border-style: solid;
            background: var(--positive-light);
        }

        .upload-file-card.required {
            border-color: var(--navy);
        }

        .upload-file-icon {
            font-size: 28px;
            margin-bottom: var(--space-sm);
        }

        .upload-file-name {
            font-weight: var(--weight-semibold);
            color: var(--navy);
            font-size: var(--font-body-sm);
            margin-bottom: var(--space-xs);
        }

        .upload-file-desc {
            font-size: var(--font-caption);
            color: var(--text-muted);
        }

        .upload-file-status {
            font-size: var(--font-caption);
            color: var(--positive);
            font-weight: var(--weight-semibold);
            margin-top: var(--space-sm);
        }

        .upload-file-badge {
            display: inline-block;
            font-size: var(--font-micro);
            padding: 2px 8px;
            border-radius: var(--radius-full);
            margin-top: var(--space-xs);
        }

        .upload-file-badge.required {
            background: var(--navy);
            color: var(--white);
        }

        .upload-file-badge.optional {
            background: var(--neutral-light);
            color: var(--text-secondary);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            color: var(--white);
            padding: 14px 32px;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-body);
            font-weight: var(--weight-semibold);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .demo-btn {
            margin-top: var(--space-md);
            background: transparent;
            border: none;
            color: var(--steel-blue);
            font-size: var(--font-caption);
            cursor: pointer;
            text-decoration: underline;
        }

        /* M-Depth Placeholder */
        .placeholder-panel {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-3xl);
            text-align: center;
            box-shadow: var(--shadow-md);
        }

        /* ============================================================================
           M-DEPTH MODE STYLES
           ============================================================================ */

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-md) 0;
            margin-bottom: var(--space-md);
            font-size: var(--font-body);
        }

        .breadcrumb-item {
            color: var(--text-muted);
        }

        .breadcrumb-item.active {
            color: var(--navy);
            font-weight: var(--weight-semibold);
        }

        .breadcrumb-item.clickable {
            cursor: pointer;
            color: var(--steel-blue);
        }

        .breadcrumb-item.clickable:hover {
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: var(--text-muted);
        }

        .breadcrumb-clear {
            margin-left: auto;
            background: var(--negative-light);
            color: var(--negative-dark);
            border: none;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: var(--font-caption);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .breadcrumb-clear:hover {
            background: var(--negative);
            color: white;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .summary-card {
            background: var(--white);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }

        .summary-label {
            font-size: var(--font-caption);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-xs);
        }

        .summary-value {
            font-size: var(--font-value-md);
            font-weight: var(--weight-bold);
            color: var(--navy);
        }

        .summary-change {
            font-size: var(--font-caption);
            margin-top: var(--space-xs);
        }

        /* Breakdown Table */
        .breakdown-container {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
        }

        .breakdown-title {
            font-size: var(--font-h3);
            color: var(--navy);
            margin-bottom: var(--space-lg);
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
        }

        .breakdown-table th {
            background: var(--navy);
            color: white;
            padding: 14px 16px;
            text-align: left;
            font-size: var(--font-caption);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .breakdown-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .breakdown-row:hover {
            background: var(--light-bg);
        }

        .breakdown-name {
            font-weight: var(--weight-semibold);
            color: var(--navy);
        }

        .breakdown-value {
            font-weight: var(--weight-bold);
        }

        .breakdown-share {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .share-bar-container {
            width: 80px;
            height: 8px;
            background: var(--neutral-light);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .share-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--steel-blue) 0%, var(--navy) 100%);
            border-radius: var(--radius-sm);
        }

        .breakdown-variance {
            font-weight: var(--weight-semibold);
        }

        .drill-btn {
            background: var(--steel-blue);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--font-body);
            transition: all var(--transition-fast);
        }

        .drill-btn:hover {
            background: var(--navy);
            transform: translateX(2px);
        }

        /* Funnel */
        .funnel-container {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-xl);
        }

        .funnel-title {
            font-size: var(--font-h3);
            color: var(--navy);
            margin-bottom: var(--space-lg);
        }

        .funnel {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .funnel-stage {
            display: grid;
            grid-template-columns: 150px 1fr 150px;
            align-items: center;
            gap: var(--space-md);
        }

        .funnel-label {
            font-weight: var(--weight-semibold);
            color: var(--navy);
        }

        .funnel-bar-container {
            height: 36px;
            background: var(--neutral-light);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .funnel-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--steel-blue) 0%, var(--navy) 100%);
            border-radius: var(--radius-sm);
            transition: width var(--transition-slow);
        }

        .funnel-value {
            font-weight: var(--weight-bold);
            color: var(--navy);
            text-align: right;
        }

        /* Cross-Brand Insights */
        .crossbrand-insights {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
        }

        .crossbrand-insights h3 {
            font-size: var(--font-h3);
            color: var(--navy);
            margin-bottom: var(--space-lg);
        }

        .metric-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
        }

        .metric-card {
            background: var(--light-bg);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            text-align: center;
        }

        .metric-label {
            font-size: var(--font-caption);
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: var(--space-sm);
        }

        .metric-value {
            font-size: var(--font-value-lg);
            font-weight: var(--weight-bold);
            color: var(--navy);
        }

        .metric-change {
            font-size: var(--font-caption);
            margin-top: var(--space-xs);
        }

        /* Segments Grid */
        .segments-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .segment-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
        }

        .segment-card h3 {
            font-size: var(--font-h3);
            color: var(--navy);
            margin-bottom: var(--space-lg);
        }

        /* Donut Chart */
        .donut-container {
            display: flex;
            justify-content: center;
            margin-bottom: var(--space-lg);
        }

        .donut-chart {
            width: 180px;
            height: 180px;
        }

        .donut-total-label {
            font-size: 12px;
            fill: var(--text-muted);
        }

        .donut-total-value {
            font-size: 18px;
            font-weight: var(--weight-bold);
            fill: var(--navy);
        }

        .donut-legend {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: var(--font-body);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Redemption Metrics */
        .redemption-metrics {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }

        .redemption-metric {
            text-align: center;
            padding: var(--space-md);
            background: var(--light-bg);
            border-radius: var(--radius-md);
        }

        .redemption-label {
            font-size: var(--font-caption);
            color: var(--text-muted);
            margin-bottom: var(--space-xs);
        }

        .redemption-value {
            font-size: var(--font-value-md);
            font-weight: var(--weight-bold);
            color: var(--navy);
        }

        .redemption-change {
            font-size: var(--font-caption);
            margin-top: var(--space-xs);
        }

        /* Behavior Metrics */
        .behavior-metrics {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
        }

        .behavior-metrics h3 {
            font-size: var(--font-h3);
            color: var(--navy);
            margin-bottom: var(--space-lg);
        }

        /* Brand Scorecard */
        .brand-scorecard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .brand-score-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            text-align: center;
            border-top: 4px solid var(--steel-blue);
        }

        .brand-score-icon {
            color: var(--steel-blue);
            margin-bottom: var(--space-sm);
        }

        .brand-score-icon svg {
            width: 28px;
            height: 28px;
        }

        .brand-score-label {
            font-size: var(--font-caption);
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: var(--space-xs);
        }

        .brand-score-value {
            font-size: var(--font-value-lg);
            font-weight: var(--weight-bold);
            color: var(--navy);
        }

        .brand-score-change {
            font-size: var(--font-caption);
            margin-top: var(--space-xs);
        }

        /* Engagement Matrix */
        .engagement-matrix-container {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
        }

        .engagement-matrix-container h3 {
            font-size: var(--font-h3);
            color: var(--navy);
            margin-bottom: var(--space-lg);
        }

        .engagement-matrix {
            width: 100%;
            border-collapse: collapse;
        }

        .engagement-matrix th,
        .engagement-matrix td {
            padding: var(--space-md);
            text-align: center;
            border: 1px solid var(--border-light);
        }

        .engagement-matrix th {
            background: var(--light-bg);
            font-weight: var(--weight-semibold);
            color: var(--navy);
            font-size: var(--font-body-sm);
        }

        .engagement-matrix .matrix-label {
            text-align: left;
            font-weight: var(--weight-semibold);
            color: var(--navy);
            background: var(--light-bg);
        }

        .engagement-matrix .matrix-cell {
            min-width: 120px;
        }

        .engagement-matrix .matrix-cell .cell-pct {
            font-size: var(--font-value-sm);
            font-weight: var(--weight-bold);
            color: var(--navy);
        }

        .engagement-matrix .matrix-cell .cell-count {
            font-size: var(--font-caption);
            color: var(--text-muted);
            margin-top: var(--space-xs);
        }

        .engagement-matrix .matrix-best {
            background: var(--positive-light);
        }

        .engagement-matrix .matrix-mid {
            background: var(--warning-light);
        }

        .engagement-matrix .matrix-worst {
            background: var(--negative-light);
        }

        /* Brand Pairs Table */
        .brand-pairs-container {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            margin-top: var(--space-lg);
        }

        .brand-pairs-container h3 {
            font-size: var(--font-h3);
            color: var(--navy);
            margin-bottom: var(--space-lg);
        }

        .brand-pairs-table {
            width: 100%;
            border-collapse: collapse;
        }

        .brand-pairs-table th,
        .brand-pairs-table td {
            padding: var(--space-md);
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        .brand-pairs-table th {
            background: var(--light-bg);
            font-weight: var(--weight-semibold);
            color: var(--navy);
            font-size: var(--font-body-sm);
        }

        .brand-pairs-table .pair-rank {
            font-weight: var(--weight-bold);
            color: var(--steel-blue);
            width: 50px;
        }

        .brand-pairs-table .pair-brands {
            font-weight: var(--weight-medium);
        }

        .brand-pairs-table .pair-count {
            font-weight: var(--weight-semibold);
            text-align: right;
        }

        .brand-pairs-table .pair-variance {
            text-align: right;
        }

        .brand-kpi-table-container {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
        }

        .brand-kpi-table-container h3 {
            font-size: var(--font-h3);
            color: var(--navy);
            margin-bottom: var(--space-lg);
        }

        .placeholder-icon {
            font-size: 64px;
            margin-bottom: var(--space-lg);
        }

        .placeholder-title {
            font-size: var(--font-h2);
            color: var(--navy);
            margin-bottom: var(--space-sm);
        }

        .placeholder-text {
            color: var(--text-muted);
            max-width: 400px;
            margin: 0 auto;
        }

        /* Data Timestamp */
        .data-timestamp {
            position: fixed;
            bottom: 24px;
            left: 24px;
            background: var(--white);
            padding: 10px 16px;
            border-radius: var(--radius-full);
            font-size: var(--font-caption);
            color: var(--text-muted);
            box-shadow: var(--shadow-md);
            z-index: var(--z-dropdown);
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div class="chart-tooltip" id="chartTooltip"></div>

    <script>
    (function() {
        'use strict';

        // ============================================================================
        // CONSTANTS
        // ============================================================================

        const MONTHS = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
        const MONTH_LABELS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        const CURRENT_YEAR = 2025;
        const PREVIOUS_YEAR = 2024;

        // KPI Configuration (MUSE only) with SVG icons
        const KPI_ICONS = {
            'SLS_TTL': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
            'SLS_PEN': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2v10l4.5 4.5"/></svg>',
            'MBR_TTL': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
            'MBR_NEW': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>',
            'MBR_RTN': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>',
            'AVG_ATF': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
            'AVG_AOV': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>',
            'PCT_RDM': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
            'PCT_XBP': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>',
            'PCT_NBA': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
            'AVG_BRD': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>',
            'PTS_BRN': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4"/></svg>'
        };

        const KPI_CONFIG = {
            'SLS_TTL': { name: 'Total Sales', format: 'C0', category: 'sales', icon: KPI_ICONS['SLS_TTL'] },
            'SLS_PEN': { name: 'Sales Penetration', format: 'P4', category: 'sales', icon: KPI_ICONS['SLS_PEN'] },
            'MBR_TTL': { name: 'Transacting Members', format: 'V0', category: 'members', icon: KPI_ICONS['MBR_TTL'] },
            'MBR_NEW': { name: 'New Members', format: 'V0', category: 'members', icon: KPI_ICONS['MBR_NEW'] },
            'MBR_RTN': { name: 'Returning Members', format: 'V0', category: 'members', icon: KPI_ICONS['MBR_RTN'] },
            'AVG_ATF': { name: 'Average Frequency', format: 'V2', category: 'behavior', icon: KPI_ICONS['AVG_ATF'] },
            'AVG_AOV': { name: 'Average Order Value', format: 'C0', category: 'behavior', icon: KPI_ICONS['AVG_AOV'] },
            'PCT_RDM': { name: 'Redeeming Members %', format: 'P4', category: 'loyalty', icon: KPI_ICONS['PCT_RDM'] },
            'PCT_XBP': { name: 'Cross Brand Plus %', format: 'P4', category: 'crossbrand', icon: KPI_ICONS['PCT_XBP'] },
            'PCT_NBA': { name: 'New Brand Adopters %', format: 'P4', category: 'crossbrand', icon: KPI_ICONS['PCT_NBA'] },
            'AVG_BRD': { name: 'Avg Brands Shopped', format: 'V2', category: 'crossbrand', icon: KPI_ICONS['AVG_BRD'] },
            'PTS_BRN': { name: 'Points Burned Value', format: 'C0', category: 'loyalty', icon: KPI_ICONS['PTS_BRN'] }
        };

        const HERO_KPIS = ['SLS_TTL', 'MBR_TTL', 'PCT_XBP', 'SLS_PEN'];
        const SCORECARD_KPIS = ['SLS_TTL', 'SLS_PEN', 'MBR_TTL', 'MBR_NEW', 'MBR_RTN', 'AVG_ATF', 'AVG_AOV', 'PCT_RDM', 'PCT_XBP', 'PCT_NBA', 'AVG_BRD', 'PTS_BRN'];
        const HEATMAP_KPIS = ['SLS_TTL', 'MBR_TTL', 'PCT_XBP', 'PCT_RDM'];

        const LOGO_SVG = `<img src="logo.png" alt="Company Logo" style="height: 60px; width: auto;" onerror="this.style.display='none'">`;

        // ============================================================================
        // INSIGHT RULES (from INSIGHTS_ENGINE.js)
        // ============================================================================

        const INSIGHT_RULES = [
            // CRITICAL (Red) - Priority 1
            {
                id: 'sales_below_target_critical',
                severity: 'critical',
                priority: 1,
                icon: '',
                condition: function(row) {
                    return row.Key === 'SLS_TTL' &&
                           row.Market !== 'All Markets' &&
                           row.vs_Target !== null &&
                           row.vs_Target < -0.05;
                },
                message: function(row) {
                    return `${row.Market} sales ${formatPct(Math.abs(row.vs_Target))} below target  requires attention`;
                }
            },
            {
                id: 'members_declining_critical',
                severity: 'critical',
                priority: 1,
                icon: '',
                condition: function(row) {
                    return row.Key === 'MBR_TTL' &&
                           row.Market !== 'All Markets' &&
                           row.vs_LYTD !== null &&
                           row.vs_LYTD < -0.10;
                },
                message: function(row) {
                    return `${row.Market} members down ${formatPct(Math.abs(row.vs_LYTD))} vs last year  investigate churn`;
                }
            },
            {
                id: 'penetration_drop_critical',
                severity: 'critical',
                priority: 1,
                icon: '',
                condition: function(row) {
                    return row.Key === 'SLS_PEN' &&
                           row.Market !== 'All Markets' &&
                           row.vs_LYTD !== null &&
                           row.vs_LYTD < -0.02;
                },
                message: function(row) {
                    return `${row.Market} penetration dropped ${formatPP(Math.abs(row.vs_LYTD))}  losing market share`;
                }
            },
            // WARNING (Yellow) - Priority 2
            {
                id: 'crossbrand_declining',
                severity: 'warning',
                priority: 2,
                icon: '',
                condition: function(row) {
                    return row.Key === 'PCT_XBP' &&
                           row.Market !== 'All Markets' &&
                           row.vs_LYTD !== null &&
                           row.vs_LYTD < -0.01;
                },
                message: function(row) {
                    return `${row.Market} cross-brand rate declining (${formatPP(row.vs_LYTD)} vs LY)  review program engagement`;
                }
            },
            {
                id: 'redemption_declining',
                severity: 'warning',
                priority: 2,
                icon: '',
                condition: function(row) {
                    return row.Key === 'PCT_RDM' &&
                           row.Market !== 'All Markets' &&
                           row.vs_LYTD !== null &&
                           row.vs_LYTD < -0.01;
                },
                message: function(row) {
                    return `${row.Market} redemption rate down (${formatPP(row.vs_LYTD)} vs LY)  check reward relevance`;
                }
            },
            {
                id: 'aov_declining',
                severity: 'warning',
                priority: 2,
                icon: '',
                condition: function(row) {
                    return row.Key === 'AVG_AOV' &&
                           row.Market !== 'All Markets' &&
                           row.vs_LYTD !== null &&
                           row.vs_LYTD < -0.05;
                },
                message: function(row) {
                    return `${row.Market} average order value down ${formatPct(Math.abs(row.vs_LYTD))}  review pricing/mix`;
                }
            },
            {
                id: 'sales_slightly_below_target',
                severity: 'warning',
                priority: 2,
                icon: '',
                condition: function(row) {
                    return row.Key === 'SLS_TTL' &&
                           row.Market !== 'All Markets' &&
                           row.vs_Target !== null &&
                           row.vs_Target >= -0.05 &&
                           row.vs_Target < 0;
                },
                message: function(row) {
                    return `${row.Market} sales ${formatPct(Math.abs(row.vs_Target))} below target  monitor closely`;
                }
            },
            // POSITIVE (Green) - Priority 3
            {
                id: 'sales_beating_target',
                severity: 'positive',
                priority: 3,
                icon: '',
                condition: function(row) {
                    return row.Key === 'SLS_TTL' &&
                           row.Market !== 'All Markets' &&
                           row.vs_Target !== null &&
                           row.vs_Target > 0.05;
                },
                message: function(row) {
                    return `${row.Market} sales ${formatPct(row.vs_Target)} above target  strong performance`;
                }
            },
            {
                id: 'crossbrand_high',
                severity: 'positive',
                priority: 3,
                icon: '',
                condition: function(row) {
                    return row.Key === 'PCT_XBP' &&
                           row.Market !== 'All Markets' &&
                           row.YTD > 0.25 &&
                           row.vs_LYTD !== null &&
                           row.vs_LYTD > 0.01;
                },
                message: function(row) {
                    return `${row.Market} cross-brand rate at ${formatPct(row.YTD)} (+${formatPP(row.vs_LYTD)} vs LY)  program success`;
                }
            },
            {
                id: 'new_members_surge',
                severity: 'positive',
                priority: 3,
                icon: '',
                condition: function(row) {
                    return row.Key === 'MBR_NEW' &&
                           row.Market !== 'All Markets' &&
                           row.vs_LYTD !== null &&
                           row.vs_LYTD > 0.15;
                },
                message: function(row) {
                    return `${row.Market} new member acquisition up ${formatPct(row.vs_LYTD)}  growth momentum`;
                }
            },
            {
                id: 'sales_strong_growth',
                severity: 'positive',
                priority: 3,
                icon: '',
                condition: function(row) {
                    return row.Key === 'SLS_TTL' &&
                           row.Market !== 'All Markets' &&
                           row.vs_LYTD !== null &&
                           row.vs_LYTD > 0.15;
                },
                message: function(row) {
                    return `${row.Market} sales up ${formatPct(row.vs_LYTD)} vs last year  excellent growth`;
                }
            }
        ];

        // ============================================================================
        // STATE
        // ============================================================================

        const state = {
            // Dashboard mode (C-Overview or M-Depth)
            dashboardMode: 'C-OVERVIEW',     // 'C-OVERVIEW' | 'M-DEPTH'
            comparisonMode: 'LYTD',          // 'LYTD' | 'Target' | 'LMR12M'
            activeTab: 'scorecard',          // 'scorecard' | 'markets' | 'trends' | 'explorer' | 'crossbrand' | 'segments' | 'branddeep'
            insightsPanelExpanded: true,
            chartType: 'monthly',            // 'monthly' | 'cumulative'

            // Data state
            dataLoaded: false,

            // Data stores (MUSE only)
            museData: null,
            museTrendData: null,
            museFileName: null,

            // P2 Data stores (M-Depth)
            dimensionalData: null,
            crossbrandData: null,

            // Filters
            selectedMonth: null,
            selectedMarket: 'All Markets',
            selectedKPI: 'SLS_TTL',

            // M-Depth Explorer state
            drillPath: [],                   // [{dimension: 'Market', value: 'UAE'}, ...]
            explorerKPI: 'SLS_TTL',

            // M-Depth Cross-Brand state
            crossbrandMarket: 'All Markets',

            // M-Depth Segments state
            segmentMarket: 'All Markets',

            // M-Depth Brand Deep Dive state
            selectedBrand: null
        };

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================

        // Safe division to avoid divide-by-zero
        function safeDiv(numerator, denominator, fallback = 0) {
            if (denominator === null || denominator === undefined ||
                denominator === 0 || Number.isNaN(denominator)) {
                return fallback;
            }
            return numerator / denominator;
        }

        // Format value for display
        function formatValue(value, format) {
            if (value === null || value === undefined || Number.isNaN(value)) {
                return '';
            }

            const num = Number(value);

            switch (format) {
                case 'C0':
                    if (Math.abs(num) >= 1000000) {
                        return '$' + (num / 1000000).toFixed(1) + 'M';
                    } else if (Math.abs(num) >= 1000) {
                        return '$' + (num / 1000).toFixed(1) + 'K';
                    }
                    return '$' + num.toLocaleString('en-US', { maximumFractionDigits: 0 });

                case 'C2':
                    return '$' + num.toFixed(2);

                case 'V0':
                    if (Math.abs(num) >= 1000000) {
                        return (num / 1000000).toFixed(1) + 'M';
                    } else if (Math.abs(num) >= 1000) {
                        return (num / 1000).toFixed(1) + 'K';
                    }
                    return num.toLocaleString('en-US', { maximumFractionDigits: 0 });

                case 'V2':
                    return num.toFixed(2);

                case 'P4':
                    return (num * 100).toFixed(1) + '%';

                default:
                    return String(num);
            }
        }

        // Format change/variance for display
        function formatChange(value, format) {
            if (value === null || value === undefined || Number.isNaN(value)) {
                return '';
            }

            const num = Number(value);
            const sign = num >= 0 ? '+' : '';
            const arrow = num >= 0 ? '' : '';

            // Percentage point formats (P*)
            if (format && format.startsWith('P')) {
                return `${arrow} ${sign}${(num * 100).toFixed(1)}pp`;
            }

            // Regular percentage change
            return `${arrow} ${sign}${(num * 100).toFixed(1)}%`;
        }

        // Format percentage for insights
        function formatPct(value) {
            if (value === null || value === undefined) return '';
            return (value * 100).toFixed(1) + '%';
        }

        // Format percentage points for insights
        function formatPP(value) {
            if (value === null || value === undefined) return '';
            const sign = value >= 0 ? '+' : '';
            return sign + (value * 100).toFixed(1) + 'pp';
        }

        // Get variance based on comparison mode
        function getVariance(row, comparisonMode) {
            if (!row) return null;

            switch (comparisonMode) {
                case 'LYTD': return row.vs_LYTD;
                case 'Target': return row.vs_Target;
                case 'LMR12M': return row.vs_LMR12M;
                default: return null;
            }
        }

        // Get comparison label
        function getComparisonLabel(comparisonMode) {
            switch (comparisonMode) {
                case 'LYTD': return 'vs LY';
                case 'Target': return 'vs Target';
                case 'LMR12M': return 'vs R12M';
                default: return '';
            }
        }

        // Get badge class based on variance
        function getBadgeClass(variance, format) {
            if (variance === null || variance === undefined) return 'neutral';

            // Percentage point metrics
            if (format && format.startsWith('P')) {
                if (variance > 0.005) return 'positive';
                if (variance < -0.005) return 'negative';
                return 'neutral';
            }

            // Percentage change metrics
            if (variance > 0.02) return 'positive';
            if (variance < -0.02) return 'negative';
            return 'neutral';
        }

        // Get row class based on vs_Target
        function getRowClass(variance) {
            if (variance === null || variance === undefined) return '';
            if (variance >= 0) return 'row-positive';
            if (variance >= -0.05) return 'row-warning';
            return 'row-negative';
        }

        // Get heatmap cell class
        function getHeatmapClass(vsTarget) {
            if (vsTarget === null || vsTarget === undefined) return 'heatmap-neutral';
            if (vsTarget >= 0) return 'heatmap-positive';
            if (vsTarget >= -0.05) return 'heatmap-warning';
            return 'heatmap-negative';
        }

        // ============================================================================
        // DYNAMIC DIMENSION EXTRACTION (Critical - no hardcoding)
        // ============================================================================

        function getUniqueDimensionValues(data, dimension) {
            return [...new Set(data.map(row => row[dimension]))]
                .filter(v => v !== null && v !== undefined && v !== '')
                .sort();
        }

        function getMarkets(data) {
            if (!data) return [];
            const markets = getUniqueDimensionValues(data, 'Market');
            // Sort with "All Markets" first
            return markets.sort((a, b) => {
                if (a === 'All Markets') return -1;
                if (b === 'All Markets') return 1;
                return a.localeCompare(b);
            });
        }

        function getMonths(data) {
            if (!data) return [];
            return getUniqueDimensionValues(data, 'Month').sort();
        }

        function getLatestMonth(data) {
            const months = getMonths(data);
            return months[months.length - 1] || null;
        }

        function getKPIs(data) {
            if (!data) return [];
            return getUniqueDimensionValues(data, 'Key').filter(k => KPI_CONFIG[k]);
        }

        // ============================================================================
        // DATA FUNCTIONS
        // ============================================================================

        function getData() {
            return state.museData;
        }

        function getKPIRow(data, kpiKey, market, month) {
            return data.find(r =>
                r.Key === kpiKey &&
                r.Market === market &&
                r.Month === month
            ) || null;
        }

        function filterData(data, { month, market, kpiKey }) {
            return data.filter(row => {
                if (month && row.Month !== month) return false;
                if (market && row.Market !== market) return false;
                if (kpiKey && row.Key !== kpiKey) return false;
                return true;
            });
        }

        function getMarketsForKPI(data, kpiKey, month) {
            return data.filter(r =>
                r.Key === kpiKey &&
                r.Month === month &&
                r.Market !== 'All Markets'
            );
        }

        // ============================================================================
        // CSV PARSING
        // ============================================================================

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',');

            const numericColumns = [
                'YTD', 'LYTD', 'Target', 'R12M', 'LMR12M', 'LYR12M',
                'vs_Target', 'vs_LYTD', 'vs_LMR12M', 'vs_LYR12M'
            ];

            return lines.slice(1).map(line => {
                const values = line.split(',');
                const row = {};

                headers.forEach((header, i) => {
                    let value = values[i];

                    // Parse numeric columns
                    if (numericColumns.includes(header) || header.match(/^M\d{2}_/)) {
                        value = value === '' || value === 'null' || value === undefined ? null : parseFloat(value);
                    }

                    row[header] = value;
                });

                return row;
            });
        }

        // ============================================================================
        // INSIGHTS GENERATION
        // ============================================================================

        function generateInsights(data, month) {
            if (!data || !month) return [];

            const insights = [];
            const seen = new Set();

            const monthData = data.filter(row => row.Month === month);

            for (const row of monthData) {
                for (const rule of INSIGHT_RULES) {
                    try {
                        if (rule.condition(row)) {
                            const key = `${rule.id}_${row.Market}`;
                            if (seen.has(key)) continue;
                            seen.add(key);

                            insights.push({
                                id: rule.id,
                                severity: rule.severity,
                                priority: rule.priority,
                                icon: rule.icon,
                                message: rule.message(row),
                                market: row.Market,
                                kpi: row.Key
                            });
                        }
                    } catch (e) {
                        console.warn(`Insight rule ${rule.id} error:`, e);
                    }
                }
            }

            const severityOrder = { critical: 1, warning: 2, positive: 3, info: 4 };

            insights.sort((a, b) => {
                if (a.priority !== b.priority) return a.priority - b.priority;
                return severityOrder[a.severity] - severityOrder[b.severity];
            });

            return insights.slice(0, 5);
        }

        // ============================================================================
        // RENDER FUNCTIONS
        // ============================================================================

        function render() {
            const app = document.getElementById('app');
            if (!state.dataLoaded) {
                app.innerHTML = renderUpload();
            } else {
                app.innerHTML = renderDashboard();
            }
            attachEventListeners();
        }

        function renderUpload() {
            const hasMain = state.museData !== null;
            const hasTrends = state.museTrendData !== null;
            const hasDimensional = state.dimensionalData !== null;
            const hasCrossbrand = state.crossbrandData !== null;

            return `
                <div class="upload-overlay">
                    <div class="upload-box" style="max-width: 700px;">
                        <div class="upload-logo">${LOGO_SVG}</div>
                        <h2>MUSE Loyalty Analytics</h2>
                        <p>Upload your data files to begin. Main data is required, others are optional.</p>

                        <div class="upload-files-grid">
                            <div class="upload-file-card ${hasMain ? 'loaded' : 'required'}" data-filetype="main">
                                <input type="file" id="mainFileInput" accept=".csv" style="display:none">
                                <div class="upload-file-icon">${hasMain ? '' : ''}</div>
                                <div class="upload-file-name">metrics_main.csv</div>
                                <div class="upload-file-desc">KPI values by month/market</div>
                                <div class="upload-file-badge required">Required</div>
                                ${hasMain ? `<div class="upload-file-status"> Loaded</div>` : ''}
                            </div>

                            <div class="upload-file-card ${hasTrends ? 'loaded' : ''}" data-filetype="trends">
                                <input type="file" id="trendsFileInput" accept=".csv" style="display:none">
                                <div class="upload-file-icon">${hasTrends ? '' : ''}</div>
                                <div class="upload-file-name">metrics_trend.csv</div>
                                <div class="upload-file-desc">Monthly time series for charts</div>
                                <div class="upload-file-badge optional">Optional</div>
                                ${hasTrends ? `<div class="upload-file-status"> Loaded</div>` : ''}
                            </div>

                            <div class="upload-file-card ${hasDimensional ? 'loaded' : ''}" data-filetype="dimensional">
                                <input type="file" id="dimensionalFileInput" accept=".csv" style="display:none">
                                <div class="upload-file-icon">${hasDimensional ? '' : ''}</div>
                                <div class="upload-file-name">metrics_dimensional.csv</div>
                                <div class="upload-file-desc">Multi-dimensional drill-down (M-Depth)</div>
                                <div class="upload-file-badge optional">Optional</div>
                                ${hasDimensional ? `<div class="upload-file-status"> Loaded</div>` : ''}
                            </div>

                            <div class="upload-file-card ${hasCrossbrand ? 'loaded' : ''}" data-filetype="crossbrand">
                                <input type="file" id="crossbrandFileInput" accept=".csv" style="display:none">
                                <div class="upload-file-icon">${hasCrossbrand ? '' : ''}</div>
                                <div class="upload-file-name">crossbrand_detail.csv</div>
                                <div class="upload-file-desc">Cross-brand analysis (M-Depth)</div>
                                <div class="upload-file-badge optional">Optional</div>
                                ${hasCrossbrand ? `<div class="upload-file-status"> Loaded</div>` : ''}
                            </div>
                        </div>

                        <p class="upload-hint">Click any card to upload. Drag & drop also supported.</p>

                        <button class="btn-primary" id="startBtn" ${hasMain ? '' : 'disabled'}>
                            Start Dashboard
                        </button>
                        <button class="demo-btn" id="demoBtn">Load Demo Data</button>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            return `
                ${renderHeader()}
                ${renderTabs()}
                <main class="main">
                    ${renderContent()}
                </main>
                <div class="data-timestamp"> Data refreshed: ${state.museData?.[0]?.Refresh_Date || 'N/A'}</div>
            `;
        }

        function renderHeader() {
            return `
                <header class="header">
                    <div class="header-left">
                        <div class="logo-container">${LOGO_SVG}</div>
                        <div class="header-text">
                            <h1>MUSE Loyalty Analytics</h1>
                            <p>${CURRENT_YEAR} Performance Dashboard</p>
                        </div>
                    </div>
                    <div class="header-right">
                        ${renderModeToggle()}
                    </div>
                </header>
            `;
        }

        function renderModeToggle() {
            return `
                <div class="mode-toggle">
                    <button class="mode-toggle-btn ${state.dashboardMode === 'C-OVERVIEW' ? 'active' : ''}"
                            data-mode="C-OVERVIEW">
                        C-Overview
                    </button>
                    <button class="mode-toggle-btn ${state.dashboardMode === 'M-DEPTH' ? 'active' : ''}"
                            data-mode="M-DEPTH">
                        M-Depth
                    </button>
                </div>
            `;
        }

        function renderTabs() {
            if (state.dashboardMode === 'M-DEPTH') {
                return `
                    <nav class="nav-tabs">
                        <button class="tab-btn ${state.activeTab === 'explorer' ? 'active' : ''}" data-tab="explorer">
                            Dimension Explorer
                        </button>
                        <button class="tab-btn ${state.activeTab === 'crossbrand' ? 'active' : ''}" data-tab="crossbrand">
                            Cross-Brand
                        </button>
                        <button class="tab-btn ${state.activeTab === 'segments' ? 'active' : ''}" data-tab="segments">
                            Segments
                        </button>
                        <button class="tab-btn ${state.activeTab === 'branddeep' ? 'active' : ''}" data-tab="branddeep">
                            Brand Deep Dive
                        </button>
                    </nav>
                `;
            }

            return `
                <nav class="nav-tabs">
                    <button class="tab-btn ${state.activeTab === 'scorecard' ? 'active' : ''}" data-tab="scorecard">
                        Executive Scorecard
                    </button>
                    <button class="tab-btn ${state.activeTab === 'markets' ? 'active' : ''}" data-tab="markets">
                        Market Performance
                    </button>
                    <button class="tab-btn ${state.activeTab === 'trends' ? 'active' : ''}" data-tab="trends">
                        Trends
                    </button>
                </nav>
            `;
        }

        function renderContent() {
            if (state.dashboardMode === 'M-DEPTH') {
                switch (state.activeTab) {
                    case 'explorer': return renderExplorer();
                    case 'crossbrand': return renderCrossBrand();
                    case 'segments': return renderSegments();
                    case 'branddeep': return renderBrandDeepDive();
                    default: return renderExplorer();
                }
            }

            switch (state.activeTab) {
                case 'scorecard': return renderScorecard();
                case 'markets': return renderMarkets();
                case 'trends': return renderTrends();
                default: return renderScorecard();
            }
        }

        // ============================================================================
        // M-DEPTH MODE RENDER FUNCTIONS
        // ============================================================================

        function renderExplorer() {
            const data = getData();
            const month = state.selectedMonth || getLatestMonth(data);

            return `
                ${renderBreadcrumb()}
                ${renderExplorerFilters()}
                <div class="section-header">
                    <div>
                        <div class="section-title">Dimension Explorer</div>
                        <div class="section-subtitle">Drill down through dimensions | ${month}</div>
                    </div>
                </div>
                ${renderExplorerSummaryCards(data, month)}
                ${renderBreakdownTable(data, month)}
            `;
        }

        function renderBreadcrumb() {
            if (state.drillPath.length === 0) {
                return `
                    <div class="breadcrumb">
                        <span class="breadcrumb-item active">All Data</span>
                    </div>
                `;
            }

            const items = state.drillPath.map((step, i) => `
                <span class="breadcrumb-item clickable" data-level="${i}">${step.value}</span>
                <span class="breadcrumb-separator"></span>
            `).join('');

            return `
                <div class="breadcrumb">
                    <span class="breadcrumb-item clickable" data-level="-1">All Data</span>
                    <span class="breadcrumb-separator"></span>
                    ${items}
                    <button class="breadcrumb-clear" onclick="handleClearDrillPath()">Clear</button>
                </div>
            `;
        }

        function renderExplorerFilters() {
            const data = getData();
            const kpis = getKPIs(data);

            return `
                <div class="filter-row">
                    <div class="filter-group">
                        <label>KPI</label>
                        <select class="filter-select" id="explorerKPISelect">
                            ${kpis.map(k => `
                                <option value="${k}" ${k === state.explorerKPI ? 'selected' : ''}>${KPI_CONFIG[k]?.name || k}</option>
                            `).join('')}
                        </select>
                    </div>
                </div>
            `;
        }

        function renderExplorerSummaryCards(data, month) {
            // Get filtered data based on drill path
            let filteredData = data.filter(r => r.Month === month);
            for (const step of state.drillPath) {
                filteredData = filteredData.filter(r => r[step.dimension] === step.value);
            }

            // Get totals for key KPIs
            const heroKPIs = ['SLS_TTL', 'MBR_TTL', 'AVG_ATF', 'AVG_AOV'];
            const cards = heroKPIs.map(kpiKey => {
                const kpiData = filteredData.find(r => r.Key === kpiKey);
                const config = KPI_CONFIG[kpiKey];

                if (!kpiData) {
                    return `<div class="summary-card"><div class="summary-label">${config?.name || kpiKey}</div><div class="summary-value"></div></div>`;
                }

                return `
                    <div class="summary-card">
                        <div class="summary-label">${config.name}</div>
                        <div class="summary-value">${formatValue(kpiData.YTD, kpiData.Format)}</div>
                        <div class="summary-change ${getBadgeClass(kpiData.vs_LYTD, kpiData.Format)}">${formatChange(kpiData.vs_LYTD, kpiData.Format)} vs LY</div>
                    </div>
                `;
            }).join('');

            return `<div class="summary-cards">${cards}</div>`;
        }

        function renderBreakdownTable(data, month) {
            // Determine next dimension to drill into
            const dimensionOrder = ['Market', 'Brand', 'Channel', 'Store_Type'];
            const currentDepth = state.drillPath.length;
            const nextDimension = dimensionOrder[currentDepth] || null;

            if (!nextDimension) {
                return `<div class="insights-empty">Maximum drill depth reached.</div>`;
            }

            // Get filtered data based on current drill path
            let filteredData = data.filter(r => r.Month === month && r.Key === state.explorerKPI);
            for (const step of state.drillPath) {
                filteredData = filteredData.filter(r => r[step.dimension] === step.value);
            }

            // Get unique values for next dimension
            const values = [...new Set(filteredData.map(r => r[nextDimension]))].filter(v => v && v !== 'All Markets');

            if (values.length === 0) {
                return `<div class="insights-empty">No breakdown data available for ${nextDimension}.</div>`;
            }

            // Calculate totals for parent
            const parentTotal = filteredData.reduce((sum, r) => sum + (r.YTD || 0), 0);

            const rows = values.map(value => {
                const rowData = filteredData.find(r => r[nextDimension] === value);
                if (!rowData) return '';

                const share = safeDiv(rowData.YTD, parentTotal, 0);
                const vsLYClass = getBadgeClass(rowData.vs_LYTD, rowData.Format);

                return `
                    <tr class="breakdown-row" data-dimension="${nextDimension}" data-value="${value}">
                        <td class="breakdown-name">${value}</td>
                        <td class="breakdown-value">${formatValue(rowData.YTD, rowData.Format)}</td>
                        <td class="breakdown-share">
                            <div class="share-bar-container">
                                <div class="share-bar" style="width: ${share * 100}%"></div>
                            </div>
                            <span>${(share * 100).toFixed(1)}%</span>
                        </td>
                        <td class="breakdown-variance ${vsLYClass}">${formatChange(rowData.vs_LYTD, rowData.Format)}</td>
                        <td class="breakdown-drill">
                            <button class="drill-btn" data-dimension="${nextDimension}" data-value="${value}"></button>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="breakdown-container">
                    <h3 class="breakdown-title">Breakdown by ${nextDimension}</h3>
                    <table class="breakdown-table">
                        <thead>
                            <tr>
                                <th>${nextDimension}</th>
                                <th>${KPI_CONFIG[state.explorerKPI]?.name || state.explorerKPI}</th>
                                <th>Share</th>
                                <th>vs LY</th>
                                <th>Drill</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        function renderCrossBrand() {
            const data = getData();
            const month = state.selectedMonth || getLatestMonth(data);
            const markets = getMarkets(data);

            return `
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Market</label>
                        <select class="filter-select" id="crossbrandMarketSelect">
                            ${markets.map(m => `
                                <option value="${m}" ${m === state.crossbrandMarket ? 'selected' : ''}>${m}</option>
                            `).join('')}
                        </select>
                    </div>
                </div>
                <div class="section-header">
                    <div>
                        <div class="section-title">Cross-Brand Analysis</div>
                        <div class="section-subtitle">Member shopping behavior across brands | ${state.crossbrandMarket}</div>
                    </div>
                </div>
                ${renderCrossBrandFunnel(data, month)}
                ${renderCrossBrandInsights(data, month)}
                ${renderBrandPairsTable(data, month)}
            `;
        }

        function renderBrandPairsTable(data, month) {
            // Use crossbrand data if available, otherwise generate from main data
            const crossbrandData = state.crossbrandData;

            if (crossbrandData && crossbrandData.length > 0) {
                // Filter for brand pairs (where Crossbrand_Type is PAIR or both brands are set)
                const pairs = crossbrandData
                    .filter(r =>
                        (r.Crossbrand_Type === 'PAIR' || (r.Home_Brand && r.Second_Brand)) &&
                        (state.crossbrandMarket === 'All Markets' || r.Market === state.crossbrandMarket)
                    )
                    .sort((a, b) => (b.Member_Count || 0) - (a.Member_Count || 0))
                    .slice(0, 10);

                if (pairs.length === 0) {
                    return renderBrandPairsPlaceholder();
                }

                const rows = pairs.map((row, i) => `
                    <tr>
                        <td class="pair-rank">${i + 1}</td>
                        <td class="pair-brands">${row.Home_Brand} + ${row.Second_Brand}</td>
                        <td class="pair-count">${formatValue(row.Member_Count, 'V0')}</td>
                        <td class="pair-variance ${getBadgeClass(row.vs_LYTD, 'P4')}">${formatChange(row.vs_LYTD, 'P4')}</td>
                    </tr>
                `).join('');

                return `
                    <div class="brand-pairs-container">
                        <h3>Top Brand Pairs</h3>
                        <table class="brand-pairs-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Brand Pair</th>
                                    <th style="text-align:right">Members</th>
                                    <th style="text-align:right">vs LY</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                `;
            }

            // Generate placeholder brand pairs based on available data
            return renderBrandPairsPlaceholder();
        }

        function renderBrandPairsPlaceholder() {
            // Generate simulated brand pairs from available data
            const marketData = getData().filter(r =>
                r.Month === (state.selectedMonth || getLatestMonth(getData())) &&
                r.Market === state.crossbrandMarket
            );
            const totalMembers = marketData.find(r => r.Key === 'MBR_TTL')?.YTD || 0;
            const xbpPct = marketData.find(r => r.Key === 'PCT_XBP')?.YTD || 0;
            const xbMembers = Math.round(totalMembers * xbpPct);

            // Simulated brand pairs based on typical distributions
            const simulatedPairs = [
                { brands: 'Level Shoes + Faces', members: Math.round(xbMembers * 0.22), change: 0.082 },
                { brands: 'Faces + Swarovski', members: Math.round(xbMembers * 0.18), change: 0.054 },
                { brands: 'Level Shoes + Swarovski', members: Math.round(xbMembers * 0.15), change: -0.021 },
                { brands: 'Level Shoes + Bloomingdale\'s', members: Math.round(xbMembers * 0.12), change: 0.112 },
                { brands: 'Faces + Bloomingdale\'s', members: Math.round(xbMembers * 0.10), change: 0.067 }
            ];

            const rows = simulatedPairs.map((pair, i) => `
                <tr>
                    <td class="pair-rank">${i + 1}</td>
                    <td class="pair-brands">${pair.brands}</td>
                    <td class="pair-count">${formatValue(pair.members, 'V0')}</td>
                    <td class="pair-variance ${getBadgeClass(pair.change, 'P4')}">${formatChange(pair.change, 'P4')}</td>
                </tr>
            `).join('');

            return `
                <div class="brand-pairs-container">
                    <h3>Top Brand Pairs</h3>
                    <p style="font-size: var(--font-caption); color: var(--text-muted); margin-bottom: var(--space-md);">
                        Upload crossbrand_detail.csv for actual brand pair data
                    </p>
                    <table class="brand-pairs-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Brand Pair</th>
                                <th style="text-align:right">Members</th>
                                <th style="text-align:right">vs LY</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        function renderCrossBrandFunnel(data, month) {
            // Get cross-brand data for selected market from main data
            const marketData = data.filter(r => r.Month === month && r.Market === state.crossbrandMarket);
            const totalMembers = marketData.find(r => r.Key === 'MBR_TTL')?.YTD || 0;

            // Use crossbrand data if available
            const crossbrandData = state.crossbrandData;
            let stages;

            if (crossbrandData && crossbrandData.length > 0) {
                // Filter funnel data for selected market (non-pair rows)
                const funnelData = crossbrandData.filter(r =>
                    r.Market === state.crossbrandMarket &&
                    r.Crossbrand_Type !== 'PAIR'
                );

                const totalRow = funnelData.find(r => r.Crossbrand_Type === 'TOTAL');
                const xbpRow = funnelData.find(r => r.Crossbrand_Type === 'XBP');
                const xbaRow = funnelData.find(r => r.Crossbrand_Type === 'XBA');
                const xb4Row = funnelData.find(r => r.Crossbrand_Type === 'XB4');

                const total = totalRow?.Member_Count || totalMembers;

                stages = [
                    { label: 'Total Members', count: total, pct: 1.0, vsLY: totalRow?.vs_LYTD },
                    { label: '2+ Brands (XBP)', count: xbpRow?.Member_Count || 0, pct: safeDiv(xbpRow?.Member_Count, total), vsLY: xbpRow?.vs_LYTD },
                    { label: '3+ Brands (XBA)', count: xbaRow?.Member_Count || 0, pct: safeDiv(xbaRow?.Member_Count, total), vsLY: xbaRow?.vs_LYTD },
                    { label: '4+ Brands', count: xb4Row?.Member_Count || 0, pct: safeDiv(xb4Row?.Member_Count, total), vsLY: xb4Row?.vs_LYTD }
                ];
            } else {
                // Fallback to main data estimation
                const xbpPct = marketData.find(r => r.Key === 'PCT_XBP')?.YTD || 0;
                const xbMembers = Math.round(totalMembers * xbpPct);

                stages = [
                    { label: 'Total Members', count: totalMembers, pct: 1.0 },
                    { label: '2+ Brands (XBP)', count: xbMembers, pct: xbpPct },
                    { label: '3+ Brands', count: Math.round(xbMembers * 0.4), pct: xbpPct * 0.4 },
                    { label: '4+ Brands', count: Math.round(xbMembers * 0.12), pct: xbpPct * 0.12 }
                ];
            }

            return `
                <div class="funnel-container">
                    <h3 class="funnel-title">Cross-Brand Funnel</h3>
                    <div class="funnel">
                        ${stages.map(stage => `
                            <div class="funnel-stage">
                                <div class="funnel-label">${stage.label}</div>
                                <div class="funnel-bar-container">
                                    <div class="funnel-bar" style="width: ${stage.pct * 100}%"></div>
                                </div>
                                <div class="funnel-value">
                                    ${formatValue(stage.count, 'V0')} (${(stage.pct * 100).toFixed(1)}%)
                                    ${stage.vsLY !== undefined ? `<span class="${getBadgeClass(stage.vsLY, 'P4')}" style="font-size: 11px; margin-left: 6px;">${formatChange(stage.vsLY, 'P4')}</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderCrossBrandInsights(data, month) {
            const marketData = data.filter(r => r.Month === month && r.Market === state.crossbrandMarket);
            const xbpData = marketData.find(r => r.Key === 'PCT_XBP');
            const nbaData = marketData.find(r => r.Key === 'PCT_NBA');
            const avgBrdData = marketData.find(r => r.Key === 'AVG_BRD');

            return `
                <div class="crossbrand-insights">
                    <h3>Key Metrics</h3>
                    <div class="metric-cards">
                        <div class="metric-card">
                            <div class="metric-label">Cross-Brand Rate</div>
                            <div class="metric-value">${formatValue(xbpData?.YTD, 'P4')}</div>
                            <div class="metric-change ${getBadgeClass(xbpData?.vs_LYTD, 'P4')}">${formatChange(xbpData?.vs_LYTD, 'P4')} vs LY</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">New Brand Adopters</div>
                            <div class="metric-value">${formatValue(nbaData?.YTD, 'P4')}</div>
                            <div class="metric-change ${getBadgeClass(nbaData?.vs_LYTD, 'P4')}">${formatChange(nbaData?.vs_LYTD, 'P4')} vs LY</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Avg Brands Shopped</div>
                            <div class="metric-value">${formatValue(avgBrdData?.YTD, 'V2')}</div>
                            <div class="metric-change ${getBadgeClass(avgBrdData?.vs_LYTD, 'V2')}">${formatChange(avgBrdData?.vs_LYTD, 'V2')} vs LY</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSegments() {
            const data = getData();
            const month = state.selectedMonth || getLatestMonth(data);
            const markets = getMarkets(data);

            return `
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Market</label>
                        <select class="filter-select" id="segmentMarketSelect">
                            ${markets.map(m => `
                                <option value="${m}" ${m === state.segmentMarket ? 'selected' : ''}>${m}</option>
                            `).join('')}
                        </select>
                    </div>
                </div>
                <div class="section-header">
                    <div>
                        <div class="section-title">Member Segmentation</div>
                        <div class="section-subtitle">Analyze member composition | ${state.segmentMarket}</div>
                    </div>
                </div>
                <div class="segments-grid">
                    ${renderNewReturningDonut(data, month)}
                    ${renderEngagementMatrix(data, month)}
                </div>
                <div class="segments-grid">
                    ${renderRedemptionMetrics(data, month)}
                    ${renderMemberMetrics(data, month)}
                </div>
            `;
        }

        function renderEngagementMatrix(data, month) {
            const marketData = data.filter(r => r.Month === month && r.Market === state.segmentMarket);
            const totalMembers = marketData.find(r => r.Key === 'MBR_TTL')?.YTD || 0;
            const redeemingPct = marketData.find(r => r.Key === 'PCT_RDM')?.YTD || 0;

            // Calculate quadrants based on available data
            // Engaged + Redeeming: members who redeem and have high frequency
            // Using approximations based on available KPIs
            const redeemingMembers = Math.round(totalMembers * redeemingPct);
            const nonRedeemingMembers = totalMembers - redeemingMembers;

            // Simulate engagement distribution (typically 20-30% are highly engaged)
            const engagedPct = 0.21; // ~21% engaged based on typical loyalty programs
            const engagedMembers = Math.round(totalMembers * engagedPct);
            const nonEngagedMembers = totalMembers - engagedMembers;

            // Calculate quadrant values
            const engRdm = Math.round(engagedMembers * 0.58); // 58% of engaged members redeem
            const engNRdm = engagedMembers - engRdm;
            const nEngRdm = redeemingMembers - engRdm;
            const nEngNRdm = totalMembers - engRdm - engNRdm - nEngRdm;

            return `
                <div class="engagement-matrix-container">
                    <h3>Engagement Matrix</h3>
                    <table class="engagement-matrix">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Redeeming</th>
                                <th>Not Redeeming</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="matrix-label">Engaged</td>
                                <td class="matrix-cell matrix-best">
                                    <div class="cell-pct">${(safeDiv(engRdm, totalMembers) * 100).toFixed(1)}%</div>
                                    <div class="cell-count">(${formatValue(engRdm, 'V0')})</div>
                                </td>
                                <td class="matrix-cell matrix-mid">
                                    <div class="cell-pct">${(safeDiv(engNRdm, totalMembers) * 100).toFixed(1)}%</div>
                                    <div class="cell-count">(${formatValue(engNRdm, 'V0')})</div>
                                </td>
                            </tr>
                            <tr>
                                <td class="matrix-label">Not Engaged</td>
                                <td class="matrix-cell matrix-mid">
                                    <div class="cell-pct">${(safeDiv(nEngRdm, totalMembers) * 100).toFixed(1)}%</div>
                                    <div class="cell-count">(${formatValue(nEngRdm, 'V0')})</div>
                                </td>
                                <td class="matrix-cell matrix-worst">
                                    <div class="cell-pct">${(safeDiv(nEngNRdm, totalMembers) * 100).toFixed(1)}%</div>
                                    <div class="cell-count">(${formatValue(nEngNRdm, 'V0')})</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderNewReturningDonut(data, month) {
            const marketData = data.filter(r => r.Month === month && r.Market === state.segmentMarket);
            const newMembers = marketData.find(r => r.Key === 'MBR_NEW')?.YTD || 0;
            const returnMembers = marketData.find(r => r.Key === 'MBR_RTN')?.YTD || 0;
            const total = newMembers + returnMembers;
            const newPct = safeDiv(newMembers, total, 0);
            const retPct = safeDiv(returnMembers, total, 0);

            // SVG donut chart
            const circumference = 2 * Math.PI * 80;

            return `
                <div class="segment-card">
                    <h3>New vs Returning Members</h3>
                    <div class="donut-container">
                        <svg class="donut-chart" viewBox="0 0 200 200">
                            <circle class="donut-bg" cx="100" cy="100" r="80" fill="none" stroke="var(--border-light)" stroke-width="24"/>
                            <circle class="donut-segment donut-new" cx="100" cy="100" r="80" fill="none"
                                    stroke="var(--steel-blue)" stroke-width="24"
                                    stroke-dasharray="${newPct * circumference} ${circumference}"
                                    transform="rotate(-90 100 100)"/>
                            <circle class="donut-segment donut-returning" cx="100" cy="100" r="80" fill="none"
                                    stroke="var(--navy)" stroke-width="24"
                                    stroke-dasharray="${retPct * circumference} ${circumference}"
                                    stroke-dashoffset="-${newPct * circumference}"
                                    transform="rotate(-90 100 100)"/>
                            <text x="100" y="95" text-anchor="middle" class="donut-total-label">Total</text>
                            <text x="100" y="115" text-anchor="middle" class="donut-total-value">${formatValue(total, 'V0')}</text>
                        </svg>
                    </div>
                    <div class="donut-legend">
                        <div class="legend-item">
                            <span class="legend-dot" style="background: var(--steel-blue)"></span>
                            New: ${formatValue(newMembers, 'V0')} (${(newPct * 100).toFixed(1)}%)
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot" style="background: var(--navy)"></span>
                            Returning: ${formatValue(returnMembers, 'V0')} (${(retPct * 100).toFixed(1)}%)
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRedemptionMetrics(data, month) {
            const marketData = data.filter(r => r.Month === month && r.Market === state.segmentMarket);
            const rdmData = marketData.find(r => r.Key === 'PCT_RDM');
            const ptsBrnData = marketData.find(r => r.Key === 'PTS_BRN');

            return `
                <div class="segment-card">
                    <h3>Redemption Activity</h3>
                    <div class="redemption-metrics">
                        <div class="redemption-metric">
                            <div class="redemption-label">Redeeming Members</div>
                            <div class="redemption-value">${formatValue(rdmData?.YTD, 'P4')}</div>
                            <div class="redemption-change ${getBadgeClass(rdmData?.vs_LYTD, 'P4')}">${formatChange(rdmData?.vs_LYTD, 'P4')} vs LY</div>
                        </div>
                        <div class="redemption-metric">
                            <div class="redemption-label">Points Burned Value</div>
                            <div class="redemption-value">${formatValue(ptsBrnData?.YTD, 'C0')}</div>
                            <div class="redemption-change ${getBadgeClass(ptsBrnData?.vs_LYTD, 'C0')}">${formatChange(ptsBrnData?.vs_LYTD, 'C0')} vs LY</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMemberMetrics(data, month) {
            const marketData = data.filter(r => r.Month === month && r.Market === state.segmentMarket);
            const atfData = marketData.find(r => r.Key === 'AVG_ATF');
            const aovData = marketData.find(r => r.Key === 'AVG_AOV');

            return `
                <div class="behavior-metrics">
                    <h3>Member Behavior</h3>
                    <div class="metric-cards">
                        <div class="metric-card">
                            <div class="metric-label">Average Frequency</div>
                            <div class="metric-value">${formatValue(atfData?.YTD, 'V2')}</div>
                            <div class="metric-change ${getBadgeClass(atfData?.vs_LYTD, 'V2')}">${formatChange(atfData?.vs_LYTD, 'V2')} vs LY</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Average Order Value</div>
                            <div class="metric-value">${formatValue(aovData?.YTD, 'C0')}</div>
                            <div class="metric-change ${getBadgeClass(aovData?.vs_LYTD, 'C0')}">${formatChange(aovData?.vs_LYTD, 'C0')} vs LY</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderBrandDeepDive() {
            const data = getData();
            const month = state.selectedMonth || getLatestMonth(data);
            const markets = getMarkets(data).filter(m => m !== 'All Markets');

            // For now, use markets as "brands" since we don't have brand-level data
            const brands = markets;

            return `
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Select Market/Brand</label>
                        <select class="filter-select" id="brandSelect">
                            <option value="">-- Select --</option>
                            ${brands.map(b => `
                                <option value="${b}" ${b === state.selectedBrand ? 'selected' : ''}>${b}</option>
                            `).join('')}
                        </select>
                    </div>
                </div>
                <div class="section-header">
                    <div>
                        <div class="section-title">Brand Deep Dive</div>
                        <div class="section-subtitle">${state.selectedBrand || 'Select a brand to analyze'}</div>
                    </div>
                </div>
                ${state.selectedBrand ? renderBrandScorecard(data, month) : renderBrandPlaceholder()}
            `;
        }

        function renderBrandPlaceholder() {
            return `
                <div class="placeholder-panel animate-fade-in">
                    <div class="placeholder-icon"></div>
                    <h2 class="placeholder-title">Select a Brand</h2>
                    <p class="placeholder-text">Choose a brand from the dropdown above to view detailed analytics.</p>
                </div>
            `;
        }

        function renderBrandScorecard(data, month) {
            const brandData = data.filter(r => r.Month === month && r.Market === state.selectedBrand);

            const kpis = ['SLS_TTL', 'MBR_TTL', 'AVG_ATF', 'AVG_AOV'];
            const cards = kpis.map(kpiKey => {
                const row = brandData.find(r => r.Key === kpiKey);
                const config = KPI_CONFIG[kpiKey];

                if (!row) return '';

                const badgeClass = getBadgeClass(row.vs_LYTD, row.Format);

                return `
                    <div class="brand-score-card">
                        <div class="brand-score-icon">${config.icon}</div>
                        <div class="brand-score-label">${config.name}</div>
                        <div class="brand-score-value">${formatValue(row.YTD, row.Format)}</div>
                        <div class="brand-score-change ${badgeClass}">${formatChange(row.vs_LYTD, row.Format)} vs LY</div>
                    </div>
                `;
            }).join('');

            return `
                <div class="brand-scorecard">${cards}</div>
                ${renderBrandKPITable(brandData)}
            `;
        }

        function renderBrandKPITable(brandData) {
            const rows = SCORECARD_KPIS.map(kpiKey => {
                const row = brandData.find(r => r.Key === kpiKey);
                const config = KPI_CONFIG[kpiKey];

                if (!row) return '';

                const vsTargetClass = getBadgeClass(row.vs_Target, row.Format);
                const vsLYClass = getBadgeClass(row.vs_LYTD, row.Format);

                return `
                    <tr class="kpi-row">
                        <td class="kpi-name">${config.name}</td>
                        <td class="kpi-value">${formatValue(row.YTD, row.Format)}</td>
                        <td class="kpi-change ${vsTargetClass}">${formatChange(row.vs_Target, row.Format)}</td>
                        <td class="kpi-change ${vsLYClass}">${formatChange(row.vs_LYTD, row.Format)}</td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="brand-kpi-table-container">
                    <h3>All KPIs</h3>
                    <table class="kpi-table">
                        <thead>
                            <tr>
                                <th>KPI</th>
                                <th>YTD</th>
                                <th>vs Target</th>
                                <th>vs LY</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        function renderMDepthPlaceholder() {
            return `
                <div class="placeholder-panel animate-fade-in">
                    <div class="placeholder-icon"></div>
                    <h2 class="placeholder-title">M-Depth Mode</h2>
                    <p class="placeholder-text">
                        Marketing deep-dive analysis coming soon. This mode will include brand drill-downs,
                        cross-brand flow analysis, and dimensional exploration.
                    </p>
                </div>
            `;
        }

        // ============================================================================
        // SCORECARD TAB
        // ============================================================================

        function renderScorecard() {
            const data = getData();
            const month = state.selectedMonth || getLatestMonth(data);
            const market = state.selectedMarket;
            const insights = generateInsights(data, month);

            return `
                ${renderFilters()}
                <div class="section-header">
                    <div>
                        <div class="section-title">Executive Scorecard</div>
                        <div class="section-subtitle">YTD ${CURRENT_YEAR} | ${market} | ${month}</div>
                    </div>
                </div>
                ${renderHeroCards(data, month, market)}
                ${renderInsightsPanel(insights)}
                ${renderKPITable(data, month, market)}
            `;
        }

        function renderFilters() {
            const data = getData();
            const months = getMonths(data);
            const markets = getMarkets(data);
            const currentMonth = state.selectedMonth || getLatestMonth(data);

            return `
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Month</label>
                        <select class="filter-select" id="monthSelect">
                            ${months.map(m => `
                                <option value="${m}" ${m === currentMonth ? 'selected' : ''}>${m}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Market</label>
                        <select class="filter-select" id="marketSelect">
                            ${markets.map(m => `
                                <option value="${m}" ${m === state.selectedMarket ? 'selected' : ''}>${m}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Compare To</label>
                        <select class="filter-select" id="comparisonSelect">
                            <option value="LYTD" ${state.comparisonMode === 'LYTD' ? 'selected' : ''}>vs Last Year</option>
                            <option value="Target" ${state.comparisonMode === 'Target' ? 'selected' : ''}>vs Target</option>
                            <option value="LMR12M" ${state.comparisonMode === 'LMR12M' ? 'selected' : ''}>vs R12M</option>
                        </select>
                    </div>
                </div>
            `;
        }

        function renderHeroCards(data, month, market) {
            const cards = HERO_KPIS.map((kpiKey, i) => {
                const row = getKPIRow(data, kpiKey, market, month);
                const config = KPI_CONFIG[kpiKey];

                if (!row) {
                    return `<div class="hero-card hero-card-empty animate-fade-in-up stagger-${i+1}">No data</div>`;
                }

                const variance = getVariance(row, state.comparisonMode);
                const badgeClass = getBadgeClass(variance, row.Format);
                const cardClass = `card-${badgeClass}`;

                // Get comparison value for context
                let comparisonValue = null;
                let comparisonLabel = '';
                switch (state.comparisonMode) {
                    case 'LYTD':
                        comparisonValue = row.LYTD;
                        comparisonLabel = 'LYTD';
                        break;
                    case 'Target':
                        comparisonValue = row.Target;
                        comparisonLabel = 'Target';
                        break;
                    case 'LMR12M':
                        comparisonValue = row.LMR12M;
                        comparisonLabel = 'LM R12M';
                        break;
                }

                return `
                    <div class="hero-card ${cardClass} animate-fade-in-up stagger-${i+1}">
                        <div class="hero-card-header">
                            <span class="hero-card-icon">${config.icon || ''}</span>
                            <span class="hero-card-label">${config.name.toUpperCase()}</span>
                        </div>
                        <div class="hero-card-value">${formatValue(row.YTD, row.Format)}</div>
                        <div class="hero-card-badge ${badgeClass}">
                            ${formatChange(variance, row.Format)} ${getComparisonLabel(state.comparisonMode)}
                        </div>
                        ${comparisonValue !== null ? `
                            <div class="hero-card-target">
                                <span class="target-label">${comparisonLabel}:</span>
                                <span class="target-value">${formatValue(comparisonValue, row.Format)}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            return `<div class="hero-cards">${cards}</div>`;
        }

        function renderInsightsPanel(insights) {
            const insightRows = insights.length > 0
                ? insights.map(insight => `
                    <div class="insight-row insight-${insight.severity}">
                        <span class="insight-icon">${insight.icon}</span>
                        <span class="insight-text">${insight.message}</span>
                    </div>
                `).join('')
                : '<div class="insights-empty">No notable insights for this period.</div>';

            return `
                <div class="insights-panel ${state.insightsPanelExpanded ? '' : 'collapsed'}" id="insightsPanel">
                    <div class="insights-header" id="insightsHeader">
                        <span class="insights-title"> Key Insights</span>
                        <button class="insights-toggle" aria-label="Toggle insights">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="4 6 8 10 12 6"></polyline>
                            </svg>
                        </button>
                    </div>
                    <div class="insights-content">
                        ${insightRows}
                    </div>
                </div>
            `;
        }

        function renderKPITable(data, month, market) {
            const rows = SCORECARD_KPIS.map(kpiKey => {
                const row = getKPIRow(data, kpiKey, market, month);
                const config = KPI_CONFIG[kpiKey];

                if (!row) return '';

                const vsTargetClass = getBadgeClass(row.vs_Target, row.Format);
                const vsLYClass = getBadgeClass(row.vs_LYTD, row.Format);
                const rowClass = getRowClass(row.vs_Target);

                return `
                    <tr class="kpi-row ${rowClass}">
                        <td class="kpi-name">${config.name}</td>
                        <td class="kpi-value">${formatValue(row.YTD, row.Format)}</td>
                        <td class="kpi-value">${formatValue(row.Target, row.Format)}</td>
                        <td class="kpi-change ${vsTargetClass}">${formatChange(row.vs_Target, row.Format)}</td>
                        <td class="kpi-value">${formatValue(row.LYTD, row.Format)}</td>
                        <td class="kpi-change ${vsLYClass}">${formatChange(row.vs_LYTD, row.Format)}</td>
                    </tr>
                `;
            }).join('');

            return `
                <table class="kpi-table">
                    <thead>
                        <tr>
                            <th>KPI</th>
                            <th>YTD</th>
                            <th>Target</th>
                            <th>vs Target</th>
                            <th>LYTD</th>
                            <th>vs LY</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
        }

        // ============================================================================
        // MARKETS TAB
        // ============================================================================

        function renderMarkets() {
            const data = getData();
            const month = state.selectedMonth || getLatestMonth(data);
            const kpis = getKPIs(data);

            return `
                ${renderMarketsFilters(kpis)}
                <div class="section-header">
                    <div>
                        <div class="section-title">Market Performance</div>
                        <div class="section-subtitle">${KPI_CONFIG[state.selectedKPI]?.name || state.selectedKPI} | ${month}</div>
                    </div>
                </div>
                ${renderMarketBars(data, month, state.selectedKPI)}
                ${renderHeatmap(data, month)}
            `;
        }

        function renderMarketsFilters(kpis) {
            const data = getData();
            const months = getMonths(data);
            const currentMonth = state.selectedMonth || getLatestMonth(data);

            return `
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Month</label>
                        <select class="filter-select" id="monthSelect">
                            ${months.map(m => `
                                <option value="${m}" ${m === currentMonth ? 'selected' : ''}>${m}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>KPI</label>
                        <select class="filter-select" id="kpiSelect">
                            ${kpis.map(k => `
                                <option value="${k}" ${k === state.selectedKPI ? 'selected' : ''}>${KPI_CONFIG[k]?.name || k}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Compare To</label>
                        <select class="filter-select" id="comparisonSelect">
                            <option value="LYTD" ${state.comparisonMode === 'LYTD' ? 'selected' : ''}>vs Last Year</option>
                            <option value="Target" ${state.comparisonMode === 'Target' ? 'selected' : ''}>vs Target</option>
                            <option value="LMR12M" ${state.comparisonMode === 'LMR12M' ? 'selected' : ''}>vs R12M</option>
                        </select>
                    </div>
                </div>
            `;
        }

        function renderMarketBars(data, month, kpiKey) {
            const marketsData = getMarketsForKPI(data, kpiKey, month);

            if (marketsData.length === 0) {
                return '<div class="insights-empty">No market data available</div>';
            }

            // Sort by value descending
            marketsData.sort((a, b) => (b.YTD || 0) - (a.YTD || 0));

            // Find max for scaling
            const maxValue = Math.max(...marketsData.map(r => r.YTD || 0));

            const bars = marketsData.map(row => {
                const config = KPI_CONFIG[kpiKey];
                const width = safeDiv(row.YTD, maxValue, 0) * 100;
                const variance = getVariance(row, state.comparisonMode);
                const badgeClass = getBadgeClass(variance, row.Format);

                return `
                    <div class="market-bar-row">
                        <div class="market-bar-label">${row.Market}</div>
                        <div class="market-bar-container">
                            <div class="market-bar-fill" style="width: ${width}%"></div>
                        </div>
                        <div class="market-bar-value">${formatValue(row.YTD, row.Format)}</div>
                        <div class="market-bar-badge ${badgeClass}">
                            ${formatChange(variance, row.Format)}
                        </div>
                    </div>
                `;
            }).join('');

            return `<div class="market-bars animate-fade-in">${bars}</div>`;
        }

        function renderHeatmap(data, month) {
            const markets = getMarkets(data).filter(m => m !== 'All Markets');

            if (markets.length === 0) {
                return '';
            }

            // Header row
            const headerCells = markets.map(m =>
                `<div class="heatmap-cell heatmap-header-cell">${m.substring(0, 6)}</div>`
            ).join('');

            // Data rows
            const rows = HEATMAP_KPIS.map(kpiKey => {
                const config = KPI_CONFIG[kpiKey];
                const cells = markets.map(market => {
                    const row = getKPIRow(data, kpiKey, market, month);
                    if (!row) return `<div class="heatmap-cell heatmap-neutral"></div>`;

                    const cellClass = getHeatmapClass(row.vs_Target);
                    const displayValue = formatChange(row.vs_Target, row.Format);
                    const ytdValue = formatValue(row.YTD, row.Format);
                    const targetValue = row.Target ? formatValue(row.Target, row.Format) : 'N/A';

                    // Build tooltip content
                    const tooltipText = `${market}\n${config.name}\nYTD: ${ytdValue}\nTarget: ${targetValue}\nvs Target: ${displayValue}`;

                    return `<div class="heatmap-cell ${cellClass}"
                        title="${tooltipText}"
                        data-market="${market}"
                        data-kpi="${config.name}"
                        data-ytd="${ytdValue}"
                        data-target="${targetValue}"
                        data-variance="${displayValue}">${displayValue}</div>`;
                }).join('');

                return `
                    <div class="heatmap-row">
                        <div class="heatmap-header">${config.name}</div>
                        ${cells}
                    </div>
                `;
            }).join('');

            return `
                <div class="heatmap">
                    <div class="heatmap-title">Performance vs Target Heatmap</div>
                    <div class="heatmap-legend">
                        <span class="heatmap-legend-item"><span class="heatmap-dot heatmap-positive"></span> On/Above Target</span>
                        <span class="heatmap-legend-item"><span class="heatmap-dot heatmap-warning"></span> Slightly Below (-5% to 0%)</span>
                        <span class="heatmap-legend-item"><span class="heatmap-dot heatmap-negative"></span> Below Target (&lt;-5%)</span>
                    </div>
                    <div class="heatmap-grid">
                        <div class="heatmap-row">
                            <div class="heatmap-header"></div>
                            ${headerCells}
                        </div>
                        ${rows}
                    </div>
                </div>
            `;
        }

        // ============================================================================
        // TRENDS TAB
        // ============================================================================

        function renderTrends() {
            const data = getData();
            const trendData = state.museTrendData;
            const kpis = getKPIs(data);
            const markets = getMarkets(data);

            return `
                ${renderTrendsFilters(kpis, markets)}
                <div class="section-header">
                    <div>
                        <div class="section-title">Trend Analysis</div>
                        <div class="section-subtitle">${KPI_CONFIG[state.selectedKPI]?.name || state.selectedKPI} | ${state.selectedMarket}</div>
                    </div>
                </div>
                ${trendData ? renderTrendChart(trendData) : renderTrendPlaceholder()}
            `;
        }

        function renderTrendsFilters(kpis, markets) {
            return `
                <div class="filter-row">
                    <div class="filter-group">
                        <label>KPI</label>
                        <select class="filter-select" id="kpiSelect">
                            ${kpis.map(k => `
                                <option value="${k}" ${k === state.selectedKPI ? 'selected' : ''}>${KPI_CONFIG[k]?.name || k}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Market</label>
                        <select class="filter-select" id="marketSelect">
                            ${markets.map(m => `
                                <option value="${m}" ${m === state.selectedMarket ? 'selected' : ''}>${m}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Chart Type</label>
                        <select class="filter-select" id="chartTypeSelect">
                            <option value="monthly" ${state.chartType === 'monthly' ? 'selected' : ''}>Monthly Values</option>
                            <option value="cumulative" ${state.chartType === 'cumulative' ? 'selected' : ''}>YTD Cumulative</option>
                        </select>
                    </div>
                </div>
            `;
        }

        function renderTrendChart(trendData) {
            const row = trendData.find(r =>
                r.Key === state.selectedKPI &&
                r.Market === state.selectedMarket
            );

            if (!row) {
                return renderTrendPlaceholder();
            }

            const config = KPI_CONFIG[state.selectedKPI];
            const months = [];

            // Extract monthly values
            for (let i = 1; i <= 12; i++) {
                const m = String(i).padStart(2, '0');
                months.push({
                    month: i,
                    label: MONTH_LABELS[i - 1],
                    ytd: row[`M${m}_YTD`],
                    lytd: row[`M${m}_LYTD`],
                    target: row[`M${m}_Target`]
                });
            }

            // Filter out months with no data
            const validMonths = months.filter(m => m.ytd !== null && m.ytd !== undefined);

            if (validMonths.length === 0) {
                return renderTrendPlaceholder();
            }

            // For cumulative chart, calculate running totals
            let chartData = validMonths;
            if (state.chartType === 'cumulative') {
                let cumYtd = 0, cumLytd = 0, cumTarget = 0;
                chartData = validMonths.map(m => {
                    cumYtd += m.ytd || 0;
                    cumLytd += m.lytd || 0;
                    cumTarget += m.target || 0;
                    return {
                        ...m,
                        ytd: cumYtd,
                        lytd: cumLytd,
                        target: m.target !== null ? cumTarget : null
                    };
                });
            }

            // Chart dimensions
            const width = 800;
            const height = 300;
            const padding = { top: 20, right: 20, bottom: 40, left: 70 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            // Calculate scales
            const allValues = chartData.flatMap(m => [m.ytd, m.lytd, m.target].filter(v => v !== null));
            const minVal = Math.min(...allValues) * 0.9;
            const maxVal = Math.max(...allValues) * 1.1;

            const xScale = (i) => padding.left + (i / (chartData.length - 1)) * chartWidth;
            const yScale = (v) => padding.top + chartHeight - ((v - minVal) / (maxVal - minVal)) * chartHeight;

            // Generate paths
            const ytdPath = chartData.map((m, i) =>
                `${i === 0 ? 'M' : 'L'} ${xScale(i)} ${yScale(m.ytd)}`
            ).join(' ');

            const lytdPath = chartData.map((m, i) =>
                `${i === 0 ? 'M' : 'L'} ${xScale(i)} ${yScale(m.lytd)}`
            ).join(' ');

            const targetPath = chartData.filter(m => m.target !== null).map((m, i) =>
                `${i === 0 ? 'M' : 'L'} ${xScale(chartData.indexOf(m))} ${yScale(m.target)}`
            ).join(' ');

            // Generate dots for current year line
            const dots = chartData.map((m, i) => `
                <circle class="chart-dot" cx="${xScale(i)}" cy="${yScale(m.ytd)}" r="5" fill="var(--steel-blue)"
                    data-info='${JSON.stringify({ month: m.label, ytd: m.ytd, lytd: m.lytd, target: m.target, format: config.format })}'/>
            `).join('');

            // X-axis labels
            const xLabels = chartData.map((m, i) => `
                <text x="${xScale(i)}" y="${height - 10}" text-anchor="middle" fill="var(--text-muted)" font-size="12">${m.label}</text>
            `).join('');

            // Y-axis
            const yTicks = 5;
            const yLabels = Array.from({ length: yTicks }, (_, i) => {
                const value = minVal + (maxVal - minVal) * (i / (yTicks - 1));
                const y = yScale(value);
                return `
                    <text x="${padding.left - 10}" y="${y + 4}" text-anchor="end" fill="var(--text-muted)" font-size="11">${formatValue(value, config.format)}</text>
                    <line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="var(--border-light)" stroke-dasharray="3,3"/>
                `;
            }).join('');

            const chartTitle = state.chartType === 'cumulative' ? 'YTD Cumulative Trend' : 'Monthly Trend';

            return `
                <div class="trend-chart animate-fade-in">
                    <div class="trend-chart-header">
                        <div class="trend-chart-title">${chartTitle}</div>
                        <div class="trend-legend">
                            <div class="legend-item"><div class="legend-line current"></div> ${CURRENT_YEAR}</div>
                            <div class="legend-item"><div class="legend-line lastyear"></div> ${PREVIOUS_YEAR}</div>
                            <div class="legend-item"><div class="legend-line target"></div> Target</div>
                        </div>
                    </div>
                    <svg class="chart-svg" viewBox="0 0 ${width} ${height}">
                        ${yLabels}
                        ${xLabels}
                        ${targetPath ? `<path d="${targetPath}" fill="none" stroke="var(--navy)" stroke-width="2" stroke-dasharray="4,4"/>` : ''}
                        <path d="${lytdPath}" fill="none" stroke="var(--text-muted)" stroke-width="2" stroke-dasharray="8,4"/>
                        <path d="${ytdPath}" fill="none" stroke="var(--steel-blue)" stroke-width="3"/>
                        ${dots}
                    </svg>
                </div>
            `;
        }

        function renderTrendPlaceholder() {
            return `
                <div class="trend-chart animate-fade-in">
                    <div class="trend-chart-header">
                        <div class="trend-chart-title">Monthly Trend</div>
                    </div>
                    <div class="insights-empty" style="padding: 80px;">
                        Trend data not available. Upload metrics_trend.csv for trend charts.
                    </div>
                </div>
            `;
        }

        // ============================================================================
        // EVENT HANDLERS
        // ============================================================================

        function attachEventListeners() {
            // Multi-file upload cards
            const fileCards = document.querySelectorAll('.upload-file-card');
            const mainFileInput = document.getElementById('mainFileInput');
            const trendsFileInput = document.getElementById('trendsFileInput');
            const dimensionalFileInput = document.getElementById('dimensionalFileInput');
            const crossbrandFileInput = document.getElementById('crossbrandFileInput');
            const startBtn = document.getElementById('startBtn');
            const demoBtn = document.getElementById('demoBtn');

            // Setup file card click handlers
            fileCards.forEach(card => {
                const fileType = card.dataset.filetype;
                let input;
                switch (fileType) {
                    case 'main': input = mainFileInput; break;
                    case 'trends': input = trendsFileInput; break;
                    case 'dimensional': input = dimensionalFileInput; break;
                    case 'crossbrand': input = crossbrandFileInput; break;
                }
                if (input) {
                    card.onclick = () => input.click();
                    card.ondragover = (e) => { e.preventDefault(); card.style.borderColor = 'var(--steel-blue)'; };
                    card.ondragleave = () => { card.style.borderColor = ''; };
                    card.ondrop = (e) => {
                        e.preventDefault();
                        card.style.borderColor = '';
                        const file = e.dataTransfer.files[0];
                        if (file && file.name.endsWith('.csv')) handleFileUpload(file, fileType);
                    };
                }
            });

            // Setup file input change handlers
            if (mainFileInput) {
                mainFileInput.onchange = (e) => { if (e.target.files[0]) handleFileUpload(e.target.files[0], 'main'); };
            }
            if (trendsFileInput) {
                trendsFileInput.onchange = (e) => { if (e.target.files[0]) handleFileUpload(e.target.files[0], 'trends'); };
            }
            if (dimensionalFileInput) {
                dimensionalFileInput.onchange = (e) => { if (e.target.files[0]) handleFileUpload(e.target.files[0], 'dimensional'); };
            }
            if (crossbrandFileInput) {
                crossbrandFileInput.onchange = (e) => { if (e.target.files[0]) handleFileUpload(e.target.files[0], 'crossbrand'); };
            }

            if (startBtn) {
                startBtn.onclick = () => {
                    if (state.museData) {
                        state.dataLoaded = true;
                        state.selectedMonth = getLatestMonth(state.museData);
                        render();
                    }
                };
            }

            if (demoBtn) {
                demoBtn.onclick = loadDemoData;
            }

            // Mode toggle
            document.querySelectorAll('.mode-toggle-btn').forEach(btn => {
                btn.onclick = () => {
                    state.dashboardMode = btn.dataset.mode;
                    state.activeTab = btn.dataset.mode === 'C-OVERVIEW' ? 'scorecard' : 'explorer';
                    render();
                };
            });

            // Tab clicks
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = () => {
                    if (btn.dataset.tab) {
                        state.activeTab = btn.dataset.tab;
                        render();
                    }
                };
            });

            // Filter selects
            const monthSelect = document.getElementById('monthSelect');
            if (monthSelect) {
                monthSelect.onchange = () => {
                    state.selectedMonth = monthSelect.value;
                    render();
                };
            }

            const marketSelect = document.getElementById('marketSelect');
            if (marketSelect) {
                marketSelect.onchange = () => {
                    state.selectedMarket = marketSelect.value;
                    render();
                };
            }

            const comparisonSelect = document.getElementById('comparisonSelect');
            if (comparisonSelect) {
                comparisonSelect.onchange = () => {
                    state.comparisonMode = comparisonSelect.value;
                    render();
                };
            }

            const kpiSelect = document.getElementById('kpiSelect');
            if (kpiSelect) {
                kpiSelect.onchange = () => {
                    state.selectedKPI = kpiSelect.value;
                    render();
                };
            }

            // Chart type selector (Trends tab)
            const chartTypeSelect = document.getElementById('chartTypeSelect');
            if (chartTypeSelect) {
                chartTypeSelect.onchange = () => {
                    state.chartType = chartTypeSelect.value;
                    render();
                };
            }

            // Insights panel toggle
            const insightsHeader = document.getElementById('insightsHeader');
            if (insightsHeader) {
                insightsHeader.onclick = () => {
                    state.insightsPanelExpanded = !state.insightsPanelExpanded;
                    render();
                };
            }

            // Chart tooltips
            attachChartTooltips();

            // M-Depth: Explorer KPI select
            const explorerKPISelect = document.getElementById('explorerKPISelect');
            if (explorerKPISelect) {
                explorerKPISelect.onchange = () => {
                    state.explorerKPI = explorerKPISelect.value;
                    render();
                };
            }

            // M-Depth: Cross-brand market select
            const crossbrandMarketSelect = document.getElementById('crossbrandMarketSelect');
            if (crossbrandMarketSelect) {
                crossbrandMarketSelect.onchange = () => {
                    state.crossbrandMarket = crossbrandMarketSelect.value;
                    render();
                };
            }

            // M-Depth: Segment market select
            const segmentMarketSelect = document.getElementById('segmentMarketSelect');
            if (segmentMarketSelect) {
                segmentMarketSelect.onchange = () => {
                    state.segmentMarket = segmentMarketSelect.value;
                    render();
                };
            }

            // M-Depth: Brand select
            const brandSelect = document.getElementById('brandSelect');
            if (brandSelect) {
                brandSelect.onchange = () => {
                    state.selectedBrand = brandSelect.value || null;
                    render();
                };
            }

            // M-Depth: Drill buttons
            document.querySelectorAll('.drill-btn').forEach(btn => {
                btn.onclick = () => {
                    const dimension = btn.dataset.dimension;
                    const value = btn.dataset.value;
                    if (dimension && value) {
                        state.drillPath.push({ dimension, value });
                        render();
                    }
                };
            });

            // M-Depth: Breadcrumb clicks
            document.querySelectorAll('.breadcrumb-item.clickable').forEach(item => {
                item.onclick = () => {
                    const level = parseInt(item.dataset.level);
                    if (level === -1) {
                        state.drillPath = [];
                    } else {
                        state.drillPath = state.drillPath.slice(0, level + 1);
                    }
                    render();
                };
            });
        }

        // Global function for breadcrumb clear
        window.handleClearDrillPath = function() {
            state.drillPath = [];
            render();
        };

        function attachChartTooltips() {
            const tooltip = document.getElementById('chartTooltip');
            const dots = document.querySelectorAll('.chart-dot');

            dots.forEach(dot => {
                dot.addEventListener('mouseenter', (e) => {
                    const info = JSON.parse(e.target.dataset.info);

                    // Calculate variances
                    const vsLY = info.lytd ? safeDiv(info.ytd - info.lytd, info.lytd, 0) : null;
                    const vsTarget = info.target ? safeDiv(info.ytd - info.target, info.target, 0) : null;

                    const vsLYClass = vsLY !== null ? (vsLY >= 0 ? 'positive' : 'negative') : '';
                    const vsTargetClass = vsTarget !== null ? (vsTarget >= 0 ? 'positive' : 'negative') : '';

                    tooltip.innerHTML = `
                        <div class="tooltip-title">${info.month}</div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">${CURRENT_YEAR}:</span>
                            <span class="tooltip-value">${formatValue(info.ytd, info.format)}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">${PREVIOUS_YEAR}:</span>
                            <span class="tooltip-value">${formatValue(info.lytd, info.format)}</span>
                            ${vsLY !== null ? `<span class="tooltip-change ${vsLYClass}">(${formatChange(vsLY, info.format)})</span>` : ''}
                        </div>
                        ${info.target ? `
                        <div class="tooltip-row">
                            <span class="tooltip-label">Target:</span>
                            <span class="tooltip-value">${formatValue(info.target, info.format)}</span>
                            ${vsTarget !== null ? `<span class="tooltip-change ${vsTargetClass}">(${formatChange(vsTarget, info.format)})</span>` : ''}
                        </div>
                        ` : ''}
                    `;
                    tooltip.classList.add('visible');
                });

                dot.addEventListener('mousemove', (e) => {
                    tooltip.style.left = (e.clientX + 15) + 'px';
                    tooltip.style.top = (e.clientY - 10) + 'px';
                });

                dot.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('visible');
                });
            });
        }

        // ============================================================================
        // DATA LOADING
        // ============================================================================

        function handleFileUpload(file, fileType = 'main') {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = parseCSV(e.target.result);
                    if (data.length > 0) {
                        switch (fileType) {
                            case 'main':
                                state.museData = data;
                                state.museFileName = file.name;
                                state.selectedMonth = getLatestMonth(data);
                                break;
                            case 'trends':
                                state.museTrendData = data;
                                break;
                            case 'dimensional':
                                state.dimensionalData = data;
                                break;
                            case 'crossbrand':
                                state.crossbrandData = data;
                                break;
                        }
                        render();
                    } else {
                        alert('Could not parse CSV. Please check the format.');
                    }
                } catch (err) {
                    console.error('Parse error:', err);
                    alert('Failed to parse file. Please check the format.');
                }
            };
            reader.readAsText(file);
        }

        function loadDemoData() {
            // Load all data files in parallel
            Promise.all([
                fetch('data/metrics_main.csv').then(r => r.ok ? r.text() : '').catch(() => ''),
                fetch('data/metrics_trend.csv').then(r => r.ok ? r.text() : '').catch(() => ''),
                fetch('data/metrics_dimensional.csv').then(r => r.ok ? r.text() : '').catch(() => ''),
                fetch('data/crossbrand_detail.csv').then(r => r.ok ? r.text() : '').catch(() => '')
            ]).then(([mainText, trendText, dimensionalText, crossbrandText]) => {
                // Parse main data (required)
                if (mainText) {
                    const mainData = parseCSV(mainText);
                    if (mainData.length > 0) {
                        state.museData = mainData;
                        state.museFileName = 'metrics_main.csv (demo)';
                        state.selectedMonth = getLatestMonth(mainData);
                        state.dataLoaded = true;
                    }
                }

                // Parse trend data (optional)
                if (trendText) {
                    const trendData = parseCSV(trendText);
                    if (trendData.length > 0) {
                        state.museTrendData = trendData;
                    }
                }

                // Parse dimensional data (optional)
                if (dimensionalText) {
                    const dimensionalData = parseCSV(dimensionalText);
                    if (dimensionalData.length > 0) {
                        state.dimensionalData = dimensionalData;
                    }
                }

                // Parse crossbrand data (optional)
                if (crossbrandText) {
                    const crossbrandData = parseCSV(crossbrandText);
                    if (crossbrandData.length > 0) {
                        state.crossbrandData = crossbrandData;
                    }
                }

                if (state.museData) {
                    render();
                } else {
                    alert('Could not load demo data. Please upload a file.');
                }
            }).catch(err => {
                console.error('Demo load error:', err);
                alert('Could not load demo data. Please upload a file.');
            });
        }

        // ============================================================================
        // EMBEDDED DEMO DATA (for local file viewing)
        // ============================================================================

        const DEMO_MAIN_CSV = `Refresh_Date,Month,Market,Key,KPI,Format,Mode,Category,YTD,Target,vs_Target,LYTD,vs_LYTD,R12M,LMR12M,vs_LMR12M,LYR12M,vs_LYR12M
2026-01-20,12 - Dec,All Markets,SLS_TTL,Total Sales,C0,CPBWSC,sales,125456789,130000000,-0.0349,111723456,0.1229,198765432,196543210,0.0113,178234567,0.1152
2026-01-20,12 - Dec,All Markets,SLS_PEN,Sales Penetration,P4,CPBWSC,sales,0.1820,0.2000,-0.0180,0.1950,-0.0130,0.1780,0.1760,0.0020,0.1890,-0.0110
2026-01-20,12 - Dec,All Markets,MBR_TTL,Transacting Members,V0,CPBWSC,members,456789,500000,-0.0864,422567,0.0810,534567,528901,0.0107,498234,0.0729
2026-01-20,12 - Dec,All Markets,MBR_NEW,New Members,V0,CPBWSC,members,146234,160000,-0.0860,118901,0.2299,178901,176234,0.0151,158901,0.1259
2026-01-20,12 - Dec,All Markets,MBR_RTN,Returning Members,V0,CPBWSC,members,310555,340000,-0.0866,303666,0.0227,355666,352667,0.0085,339333,0.0481
2026-01-20,12 - Dec,All Markets,AVG_ATF,Average Frequency,V2,CPB,behavior,2.34,2.50,-0.0640,2.28,0.0263,2.41,2.39,0.0084,2.31,0.0433
2026-01-20,12 - Dec,All Markets,AVG_AOV,Average Order Value,C0,CPB,behavior,287,295,-0.0271,276,0.0399,291,289,0.0069,281,0.0356
2026-01-20,12 - Dec,All Markets,PCT_RDM,Redeeming Members %,P4,CPBWSC,loyalty,0.1540,0.1800,-0.0260,0.1420,0.0120,0.1580,0.1550,0.0030,0.1380,0.0200
2026-01-20,12 - Dec,All Markets,PCT_XBP,Cross Brand Plus %,P4,CPBWSC,crossbrand,0.2340,0.2500,-0.0160,0.2130,0.0210,0.2280,0.2250,0.0030,0.2050,0.0230
2026-01-20,12 - Dec,All Markets,PCT_NBA,New Brand Adopters %,P4,CPB,crossbrand,0.0890,0.1000,-0.0110,0.0780,0.0110,0.0920,0.0900,0.0020,0.0820,0.0100
2026-01-20,12 - Dec,All Markets,AVG_BRD,Average Brands Shopped,V2,CPB,crossbrand,1.42,1.50,-0.0533,1.38,0.0290,1.45,1.43,0.0140,1.36,0.0662
2026-01-20,12 - Dec,All Markets,PTS_BRN,Points Burned Value,C0,CPB,loyalty,8234567,9000000,-0.0851,7123456,0.1560,15678901,15234567,0.0292,13456789,0.1651
2026-01-20,12 - Dec,United Arab Emirates,SLS_TTL,Total Sales,C0,CPBWSC,sales,52345678,55000000,-0.0483,45234567,0.1572,98765432,95432109,0.0349,88765432,0.1127
2026-01-20,12 - Dec,United Arab Emirates,SLS_PEN,Sales Penetration,P4,CPBWSC,sales,0.2150,0.2300,-0.0150,0.2080,0.0070,0.2100,0.2080,0.0020,0.2020,0.0080
2026-01-20,12 - Dec,United Arab Emirates,MBR_TTL,Transacting Members,V0,CPBWSC,members,178234,190000,-0.0619,165432,0.0774,212345,209876,0.0118,198765,0.0683
2026-01-20,12 - Dec,United Arab Emirates,MBR_NEW,New Members,V0,CPBWSC,members,58901,62000,-0.0500,48234,0.2212,72345,71234,0.0156,65432,0.1057
2026-01-20,12 - Dec,United Arab Emirates,MBR_RTN,Returning Members,V0,CPBWSC,members,119333,128000,-0.0677,117198,0.0182,140000,138642,0.0098,133333,0.0500
2026-01-20,12 - Dec,United Arab Emirates,AVG_ATF,Average Frequency,V2,CPB,behavior,2.45,2.60,-0.0577,2.38,0.0294,2.52,2.49,0.0120,2.42,0.0413
2026-01-20,12 - Dec,United Arab Emirates,AVG_AOV,Average Order Value,C0,CPB,behavior,312,320,-0.0250,298,0.0470,318,315,0.0095,305,0.0426
2026-01-20,12 - Dec,United Arab Emirates,PCT_RDM,Redeeming Members %,P4,CPBWSC,loyalty,0.1680,0.1900,-0.0220,0.1520,0.0160,0.1720,0.1690,0.0030,0.1480,0.0240
2026-01-20,12 - Dec,United Arab Emirates,PCT_XBP,Cross Brand Plus %,P4,CPBWSC,crossbrand,0.2830,0.3000,-0.0170,0.2540,0.0290,0.2780,0.2740,0.0040,0.2450,0.0330
2026-01-20,12 - Dec,United Arab Emirates,PCT_NBA,New Brand Adopters %,P4,CPB,crossbrand,0.1020,0.1100,-0.0080,0.0890,0.0130,0.1050,0.1020,0.0030,0.0920,0.0130
2026-01-20,12 - Dec,United Arab Emirates,AVG_BRD,Average Brands Shopped,V2,CPB,crossbrand,1.52,1.60,-0.0500,1.45,0.0483,1.55,1.53,0.0131,1.44,0.0764
2026-01-20,12 - Dec,United Arab Emirates,PTS_BRN,Points Burned Value,C0,CPB,loyalty,3456789,3800000,-0.0903,2987654,0.1571,6543210,6321098,0.0352,5654321,0.1572
2026-01-20,12 - Dec,Saudi Arabia,SLS_TTL,Total Sales,C0,CPBWSC,sales,38123456,42000000,-0.0923,40234567,-0.0524,72345678,73456789,-0.0151,68765432,0.0521
2026-01-20,12 - Dec,Saudi Arabia,SLS_PEN,Sales Penetration,P4,CPBWSC,sales,0.1620,0.1800,-0.0180,0.1780,-0.0160,0.1580,0.1600,-0.0020,0.1720,-0.0140
2026-01-20,12 - Dec,Saudi Arabia,MBR_TTL,Transacting Members,V0,CPBWSC,members,145678,160000,-0.0895,148901,-0.0216,172345,175432,-0.0176,165432,0.0418
2026-01-20,12 - Dec,Saudi Arabia,MBR_NEW,New Members,V0,CPBWSC,members,45678,52000,-0.1216,42345,0.0787,54321,55432,-0.0200,51234,0.0602
2026-01-20,12 - Dec,Saudi Arabia,MBR_RTN,Returning Members,V0,CPBWSC,members,100000,108000,-0.0741,106556,-0.0615,118024,120000,-0.0165,114198,0.0335
2026-01-20,12 - Dec,Saudi Arabia,AVG_ATF,Average Frequency,V2,CPB,behavior,2.21,2.35,-0.0596,2.25,-0.0178,2.28,2.30,-0.0087,2.22,0.0270
2026-01-20,12 - Dec,Saudi Arabia,AVG_AOV,Average Order Value,C0,CPB,behavior,265,275,-0.0364,272,-0.0257,270,272,-0.0074,268,0.0075
2026-01-20,12 - Dec,Saudi Arabia,PCT_RDM,Redeeming Members %,P4,CPBWSC,loyalty,0.1380,0.1600,-0.0220,0.1450,-0.0070,0.1420,0.1440,-0.0020,0.1400,0.0020
2026-01-20,12 - Dec,Saudi Arabia,PCT_XBP,Cross Brand Plus %,P4,CPBWSC,crossbrand,0.1850,0.2200,-0.0350,0.1980,-0.0130,0.1820,0.1850,-0.0030,0.1920,-0.0100
2026-01-20,12 - Dec,Saudi Arabia,PCT_NBA,New Brand Adopters %,P4,CPB,crossbrand,0.0720,0.0900,-0.0180,0.0750,-0.0030,0.0780,0.0790,-0.0010,0.0780,0.0000
2026-01-20,12 - Dec,Saudi Arabia,AVG_BRD,Average Brands Shopped,V2,CPB,crossbrand,1.32,1.42,-0.0704,1.35,-0.0222,1.34,1.35,-0.0074,1.33,0.0075
2026-01-20,12 - Dec,Saudi Arabia,PTS_BRN,Points Burned Value,C0,CPB,loyalty,2345678,2800000,-0.1623,2567890,-0.0865,4567890,4678901,-0.0237,4234567,0.0787
2026-01-20,12 - Dec,Kuwait,SLS_TTL,Total Sales,C0,CPBWSC,sales,21456789,22000000,-0.0247,19876543,0.0795,42345678,41234567,0.0270,38765432,0.0924
2026-01-20,12 - Dec,Kuwait,SLS_PEN,Sales Penetration,P4,CPBWSC,sales,0.1750,0.1850,-0.0100,0.1680,0.0070,0.1720,0.1700,0.0020,0.1650,0.0070
2026-01-20,12 - Dec,Kuwait,MBR_TTL,Transacting Members,V0,CPBWSC,members,78901,82000,-0.0378,72345,0.0906,92345,91234,0.0122,86543,0.0670
2026-01-20,12 - Dec,Kuwait,MBR_NEW,New Members,V0,CPBWSC,members,24567,26000,-0.0551,21234,0.1570,29876,29234,0.0220,27654,0.0804
2026-01-20,12 - Dec,Kuwait,MBR_RTN,Returning Members,V0,CPBWSC,members,54334,56000,-0.0297,51111,0.0631,62469,62000,0.0076,58889,0.0608
2026-01-20,12 - Dec,Kuwait,AVG_ATF,Average Frequency,V2,CPB,behavior,2.38,2.45,-0.0286,2.32,0.0259,2.42,2.40,0.0083,2.35,0.0298
2026-01-20,12 - Dec,Kuwait,AVG_AOV,Average Order Value,C0,CPB,behavior,298,305,-0.0230,287,0.0383,302,300,0.0067,292,0.0342
2026-01-20,12 - Dec,Kuwait,PCT_RDM,Redeeming Members %,P4,CPBWSC,loyalty,0.1620,0.1750,-0.0130,0.1480,0.0140,0.1660,0.1640,0.0020,0.1520,0.0140
2026-01-20,12 - Dec,Kuwait,PCT_XBP,Cross Brand Plus %,P4,CPBWSC,crossbrand,0.2120,0.2350,-0.0230,0.1980,0.0140,0.2080,0.2050,0.0030,0.1920,0.0160
2026-01-20,12 - Dec,Kuwait,PCT_NBA,New Brand Adopters %,P4,CPB,crossbrand,0.0850,0.0950,-0.0100,0.0780,0.0070,0.0880,0.0860,0.0020,0.0800,0.0080
2026-01-20,12 - Dec,Kuwait,AVG_BRD,Average Brands Shopped,V2,CPB,crossbrand,1.38,1.45,-0.0483,1.34,0.0299,1.40,1.39,0.0072,1.33,0.0526
2026-01-20,12 - Dec,Kuwait,PTS_BRN,Points Burned Value,C0,CPB,loyalty,1456789,1600000,-0.0895,1234567,0.1800,2876543,2812345,0.0228,2567890,0.1202
2026-01-20,12 - Dec,Bahrain,SLS_TTL,Total Sales,C0,CPBWSC,sales,13530866,11000000,0.2301,6377879,1.1217,25308642,24876543,0.0174,21938271,0.1537
2026-01-20,12 - Dec,Bahrain,SLS_PEN,Sales Penetration,P4,CPBWSC,sales,0.1980,0.1750,0.0230,0.1720,0.0260,0.1920,0.1880,0.0040,0.1680,0.0240
2026-01-20,12 - Dec,Bahrain,MBR_TTL,Transacting Members,V0,CPBWSC,members,53976,68000,-0.2062,35889,0.5039,57532,52359,0.0988,47494,0.2113
2026-01-20,12 - Dec,Bahrain,MBR_NEW,New Members,V0,CPBWSC,members,17088,22000,-0.2233,7088,1.4108,21359,20334,0.0504,15581,0.3709
2026-01-20,12 - Dec,Bahrain,MBR_RTN,Returning Members,V0,CPBWSC,members,36888,46000,-0.1981,28801,0.2808,36173,32025,0.1295,31913,0.1335
2026-01-20,12 - Dec,Bahrain,AVG_ATF,Average Frequency,V2,CPB,behavior,2.52,2.55,-0.0118,2.35,0.0723,2.58,2.54,0.0157,2.40,0.0750
2026-01-20,12 - Dec,Bahrain,AVG_AOV,Average Order Value,C0,CPB,behavior,265,270,-0.0185,245,0.0816,272,268,0.0149,258,0.0543
2026-01-20,12 - Dec,Bahrain,PCT_RDM,Redeeming Members %,P4,CPBWSC,loyalty,0.1720,0.1850,-0.0130,0.1380,0.0340,0.1760,0.1720,0.0040,0.1420,0.0340
2026-01-20,12 - Dec,Bahrain,PCT_XBP,Cross Brand Plus %,P4,CPBWSC,crossbrand,0.2450,0.2600,-0.0150,0.2020,0.0430,0.2400,0.2350,0.0050,0.1980,0.0420
2026-01-20,12 - Dec,Bahrain,PCT_NBA,New Brand Adopters %,P4,CPB,crossbrand,0.0980,0.1050,-0.0070,0.0720,0.0260,0.1020,0.0980,0.0040,0.0750,0.0270
2026-01-20,12 - Dec,Bahrain,AVG_BRD,Average Brands Shopped,V2,CPB,crossbrand,1.48,1.52,-0.0263,1.38,0.0725,1.50,1.48,0.0135,1.36,0.1029
2026-01-20,12 - Dec,Bahrain,PTS_BRN,Points Burned Value,C0,CPB,loyalty,975311,800000,0.2191,333345,1.9267,1691258,1422223,0.1892,1000001,0.6913`;

        const DEMO_TREND_CSV = `Market,Key,KPI,Format,Category,M01_YTD,M01_LYTD,M01_Target,M02_YTD,M02_LYTD,M02_Target,M03_YTD,M03_LYTD,M03_Target,M04_YTD,M04_LYTD,M04_Target,M05_YTD,M05_LYTD,M05_Target,M06_YTD,M06_LYTD,M06_Target,M07_YTD,M07_LYTD,M07_Target,M08_YTD,M08_LYTD,M08_Target,M09_YTD,M09_LYTD,M09_Target,M10_YTD,M10_LYTD,M10_Target,M11_YTD,M11_LYTD,M11_Target,M12_YTD,M12_LYTD,M12_Target
All Markets,SLS_TTL,Total Sales,C0,sales,8500000,7800000,9000000,18200000,16500000,19000000,29100000,26200000,30000000,41300000,37100000,42000000,54800000,49200000,55000000,69500000,62300000,70000000,85200000,76500000,86000000,102100000,91800000,103000000,119800000,107600000,120000000,138500000,124400000,139000000,157200000,141200000,158000000,125456789,111723456,130000000
All Markets,MBR_TTL,Transacting Members,V0,members,38000,35200,40000,78500,72100,82000,121000,111200,125000,165200,151800,170000,211500,194300,220000,259800,238500,270000,310200,284700,325000,362500,332900,380000,416800,382900,440000,473200,434600,500000,531500,488200,560000,456789,422567,500000
All Markets,PCT_XBP,Cross Brand Plus %,P4,crossbrand,0.1820,0.1650,0.2000,0.1920,0.1740,0.2100,0.2010,0.1820,0.2150,0.2080,0.1880,0.2200,0.2140,0.1940,0.2280,0.2190,0.1990,0.2350,0.2230,0.2030,0.2400,0.2260,0.2060,0.2420,0.2290,0.2090,0.2450,0.2310,0.2110,0.2480,0.2330,0.2120,0.2490,0.2340,0.2130,0.2500
All Markets,SLS_PEN,Sales Penetration,P4,sales,0.1450,0.1380,0.1600,0.1520,0.1440,0.1680,0.1580,0.1500,0.1750,0.1630,0.1550,0.1800,0.1680,0.1590,0.1850,0.1720,0.1630,0.1890,0.1750,0.1660,0.1920,0.1770,0.1690,0.1940,0.1790,0.1710,0.1960,0.1800,0.1730,0.1980,0.1810,0.1750,0.1990,0.1820,0.1950,0.2000
United Arab Emirates,SLS_TTL,Total Sales,C0,sales,3800000,3200000,4000000,8100000,6900000,8500000,13000000,11000000,13500000,18500000,15600000,19000000,24500000,20700000,25200000,31100000,26200000,32000000,38100000,32100000,39200000,45700000,38600000,47000000,53600000,45200000,55000000,62000000,52300000,63500000,70400000,59400000,72200000,52345678,45234567,55000000
United Arab Emirates,MBR_TTL,Transacting Members,V0,members,15200,13800,16000,31400,28500,33000,48400,44000,50500,66100,60000,69000,84600,76800,88500,103900,94300,109000,124100,112700,130500,145000,131700,152500,166700,151400,175500,189200,171800,199500,212500,193000,224500,178234,165432,190000
United Arab Emirates,PCT_XBP,Cross Brand Plus %,P4,crossbrand,0.2180,0.1920,0.2350,0.2320,0.2040,0.2500,0.2450,0.2150,0.2620,0.2550,0.2240,0.2720,0.2630,0.2310,0.2800,0.2690,0.2360,0.2860,0.2740,0.2400,0.2910,0.2780,0.2440,0.2950,0.2810,0.2470,0.2980,0.2830,0.2500,0.3000,0.2840,0.2520,0.3010,0.2830,0.2540,0.3000
United Arab Emirates,SLS_PEN,Sales Penetration,P4,sales,0.1720,0.1620,0.1850,0.1820,0.1710,0.1950,0.1900,0.1790,0.2030,0.1960,0.1850,0.2100,0.2010,0.1900,0.2150,0.2050,0.1940,0.2190,0.2080,0.1970,0.2220,0.2100,0.1990,0.2240,0.2120,0.2010,0.2260,0.2130,0.2030,0.2280,0.2140,0.2050,0.2290,0.2150,0.2080,0.2300
Saudi Arabia,SLS_TTL,Total Sales,C0,sales,2800000,2900000,3000000,6000000,6200000,6400000,9600000,9900000,10200000,13600000,14100000,14500000,18000000,18700000,19200000,22900000,23700000,24400000,28000000,29000000,29900000,33600000,34800000,35800000,39400000,40800000,42000000,45600000,47200000,48600000,51600000,53400000,55000000,38123456,40234567,42000000
Saudi Arabia,MBR_TTL,Transacting Members,V0,members,12200,12600,13000,25200,26000,27000,38800,40100,41500,53000,54800,56700,67900,70200,72700,83400,86200,89300,99600,102900,106600,116400,120300,124600,133800,138300,143200,151800,156900,162400,170500,176200,182500,145678,148901,160000
Saudi Arabia,PCT_XBP,Cross Brand Plus %,P4,crossbrand,0.1520,0.1580,0.1750,0.1580,0.1640,0.1820,0.1640,0.1700,0.1890,0.1690,0.1750,0.1950,0.1730,0.1800,0.2000,0.1770,0.1840,0.2050,0.1800,0.1880,0.2100,0.1820,0.1900,0.2130,0.1840,0.1930,0.2160,0.1850,0.1950,0.2180,0.1860,0.1970,0.2200,0.1850,0.1980,0.2200
Saudi Arabia,SLS_PEN,Sales Penetration,P4,sales,0.1280,0.1350,0.1420,0.1340,0.1410,0.1490,0.1400,0.1470,0.1550,0.1450,0.1520,0.1600,0.1490,0.1570,0.1650,0.1530,0.1610,0.1690,0.1560,0.1640,0.1720,0.1580,0.1670,0.1750,0.1600,0.1690,0.1780,0.1610,0.1710,0.1800,0.1620,0.1730,0.1810,0.1620,0.1780,0.1800
Kuwait,SLS_TTL,Total Sales,C0,sales,1200000,1100000,1250000,2600000,2400000,2700000,4150000,3800000,4300000,5900000,5400000,6100000,7800000,7200000,8100000,9900000,9100000,10300000,12200000,11200000,12600000,14600000,13400000,15100000,17100000,15700000,17700000,19800000,18200000,20500000,22400000,20600000,23200000,21456789,19876543,22000000
Kuwait,MBR_TTL,Transacting Members,V0,members,6400,5800,6700,13200,12000,13800,20300,18500,21300,27800,25300,29100,35600,32400,37300,43700,39800,45800,52200,47500,54700,61000,55500,63900,70100,63800,73400,79600,72500,83300,89400,81400,93600,78901,72345,82000
Kuwait,PCT_XBP,Cross Brand Plus %,P4,crossbrand,0.1680,0.1520,0.1850,0.1780,0.1610,0.1950,0.1870,0.1690,0.2050,0.1940,0.1760,0.2120,0.2000,0.1810,0.2190,0.2050,0.1860,0.2250,0.2090,0.1900,0.2300,0.2120,0.1930,0.2340,0.2140,0.1960,0.2370,0.2150,0.1980,0.2390,0.2150,0.1990,0.2400,0.2120,0.1980,0.2350
Kuwait,SLS_PEN,Sales Penetration,P4,sales,0.1380,0.1290,0.1480,0.1460,0.1370,0.1560,0.1530,0.1430,0.1630,0.1590,0.1490,0.1700,0.1640,0.1540,0.1760,0.1680,0.1580,0.1810,0.1710,0.1610,0.1850,0.1730,0.1640,0.1880,0.1750,0.1660,0.1900,0.1760,0.1680,0.1920,0.1770,0.1700,0.1930,0.1750,0.1680,0.1850
Bahrain,SLS_TTL,Total Sales,C0,sales,700000,600000,750000,1500000,1000000,1400000,2350000,1500000,2000000,3300000,2000000,2400000,4500000,2600000,2500000,5600000,3300000,3300000,6900000,4200000,4200000,8200000,5000000,5000000,9700000,5900000,5800000,11100000,6700000,6600000,12800000,7800000,7800000,13530866,6377879,11000000
Bahrain,MBR_TTL,Transacting Members,V0,members,4200,2900,4300,8700,5600,8200,13500,8600,12700,18400,11700,17200,23600,15000,22000,28900,18400,27000,34500,22000,32200,40300,25700,37600,46200,29400,43200,52400,33400,49100,58800,37600,55200,53976,35889,68000
Bahrain,PCT_XBP,Cross Brand Plus %,P4,crossbrand,0.1820,0.1480,0.1950,0.1980,0.1560,0.2100,0.2120,0.1640,0.2220,0.2230,0.1710,0.2320,0.2320,0.1770,0.2400,0.2390,0.1830,0.2470,0.2450,0.1880,0.2530,0.2480,0.1930,0.2580,0.2500,0.1970,0.2620,0.2510,0.2000,0.2650,0.2510,0.2020,0.2670,0.2450,0.2020,0.2600
Bahrain,SLS_PEN,Sales Penetration,P4,sales,0.1520,0.1280,0.1380,0.1680,0.1340,0.1460,0.1800,0.1400,0.1540,0.1890,0.1460,0.1620,0.1950,0.1520,0.1700,0.1990,0.1580,0.1780,0.2020,0.1640,0.1860,0.2040,0.1700,0.1940,0.2050,0.1760,0.2020,0.2050,0.1820,0.2100,0.2040,0.1880,0.2180,0.1980,0.1720,0.1750`;

        const DEMO_CROSSBRAND_CSV = `Refresh_Date,Month,Market,Crossbrand_Type,Home_Brand,Second_Brand,Member_Count,vs_LYTD
2026-01-20,12 - Dec,All Markets,TOTAL,,,456789,0.0810
2026-01-20,12 - Dec,All Markets,XBP,,,106889,0.0923
2026-01-20,12 - Dec,All Markets,XBA,,,42756,0.0678
2026-01-20,12 - Dec,All Markets,XB4,,,12827,0.0512
2026-01-20,12 - Dec,All Markets,PAIR,Level Shoes,Faces,23516,0.0821
2026-01-20,12 - Dec,All Markets,PAIR,Faces,Swarovski,19240,0.0543
2026-01-20,12 - Dec,All Markets,PAIR,Level Shoes,Swarovski,16034,0.0312
2026-01-20,12 - Dec,All Markets,PAIR,Level Shoes,Bloomingdale's,12827,0.1123
2026-01-20,12 - Dec,All Markets,PAIR,Faces,Bloomingdale's,10689,0.0678
2026-01-20,12 - Dec,United Arab Emirates,TOTAL,,,178234,0.0774
2026-01-20,12 - Dec,United Arab Emirates,XBP,,,50419,0.1021
2026-01-20,12 - Dec,United Arab Emirates,XBA,,,20168,0.0812
2026-01-20,12 - Dec,United Arab Emirates,XB4,,,6050,0.0623
2026-01-20,12 - Dec,United Arab Emirates,PAIR,Level Shoes,Faces,11092,0.0912
2026-01-20,12 - Dec,United Arab Emirates,PAIR,Faces,Swarovski,9076,0.0634
2026-01-20,12 - Dec,United Arab Emirates,PAIR,Level Shoes,Swarovski,7563,0.0423
2026-01-20,12 - Dec,Saudi Arabia,TOTAL,,,145678,0.0418
2026-01-20,12 - Dec,Saudi Arabia,XBP,,,26950,0.0523
2026-01-20,12 - Dec,Saudi Arabia,XBA,,,10780,0.0312
2026-01-20,12 - Dec,Saudi Arabia,XB4,,,3234,0.0212
2026-01-20,12 - Dec,Saudi Arabia,PAIR,Level Shoes,Faces,5930,0.0612
2026-01-20,12 - Dec,Saudi Arabia,PAIR,Faces,Swarovski,4851,0.0423
2026-01-20,12 - Dec,Saudi Arabia,PAIR,Level Shoes,Swarovski,4043,0.0234`;

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        function loadEmbeddedDemoData() {
            // Load from embedded data (works when opening file locally)
            const mainData = parseCSV(DEMO_MAIN_CSV);
            const trendData = parseCSV(DEMO_TREND_CSV);
            const crossbrandData = parseCSV(DEMO_CROSSBRAND_CSV);

            if (mainData.length > 0) {
                state.museData = mainData;
                state.museFileName = 'Demo Data (embedded)';
                state.selectedMonth = getLatestMonth(mainData);
                state.dataLoaded = true;
            }
            if (trendData.length > 0) {
                state.museTrendData = trendData;
            }
            if (crossbrandData.length > 0) {
                state.crossbrandData = crossbrandData;
            }
            render();
        }

        function init() {
            // Check for auto-load parameter
            const urlParams = new URLSearchParams(window.location.search);
            const autoLoad = urlParams.get('demo') === 'true' || urlParams.get('autoload') === 'true';

            if (autoLoad) {
                // Try fetching from files first, fall back to embedded
                loadDemoData();
            } else {
                render();
            }
        }

        document.addEventListener('DOMContentLoaded', init);

    })();
    </script>
</body>
</html>
