<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUSE Loyalty Analytics Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* Colors - Modern Premium Palette */
            --navy: #1B365D;
            --navy-dark: #0F1D35;
            --navy-light: #2A4A7A;
            --steel-blue: #3B82F6;
            --steel-blue-light: #60A5FA;
            --light-steel: #DBEAFE;
            --gold: #D4AF37;
            --gold-light: #F4E4B0;
            --positive: #10B981;
            --positive-light: #D1FAE5;
            --positive-dark: #059669;
            --negative: #EF4444;
            --negative-light: #FEE2E2;
            --negative-dark: #DC2626;
            --warning: #F59E0B;
            --warning-light: #FEF3C7;
            --warning-dark: #D97706;
            --neutral: #6B7280;
            --neutral-light: #F3F4F6;
            --positive-soft: #34D399;
            --negative-soft: #F87171;
            --neutral-soft: #FBBF24;
            --white: #FFFFFF;
            --light-bg: #F8FAFC;
            --card-bg: #FFFFFF;
            --section-bg: #F1F5F9;
            --light-bg-gradient: linear-gradient(135deg, #F8FAFC 0%, #EEF2FF 100%);
            --text-dark: #1B365D;
            --text-primary: #1E293B;
            --text-secondary: #475569;
            --text-muted: #64748B;
            --text-light: #94A3B8;
            --border-light: #E2E8F0;
            --border-medium: #CBD5E1;
            --shadow-sm: 0 1px 2px rgba(27, 54, 93, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(27, 54, 93, 0.1), 0 2px 4px -1px rgba(27, 54, 93, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(27, 54, 93, 0.1), 0 4px 6px -2px rgba(27, 54, 93, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(27, 54, 93, 0.1), 0 10px 10px -5px rgba(27, 54, 93, 0.04);
            --shadow-card: 0 2px 8px rgba(27, 54, 93, 0.08);
            --shadow-glow-positive: 0 0 20px rgba(16, 185, 129, 0.3);
            --shadow-glow-negative: 0 0 20px rgba(239, 68, 68, 0.3);

            /* Typography Scale */
            --font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --font-display: 56px;
            --font-h1: 28px;
            --font-h2: 24px;
            --font-h3: 20px;
            --font-value-xl: 36px;
            --font-value-lg: 28px;
            --font-value-md: 24px;
            --font-value-sm: 17px;
            --font-body-lg: 16px;
            --font-body: 15px;
            --font-body-sm: 14px;
            --font-small: 13px;
            --font-caption: 13px;
            --font-label: 12px;
            --font-micro: 11px;

            /* Font Weights */
            --weight-normal: 400;
            --weight-medium: 500;
            --weight-semibold: 600;
            --weight-bold: 700;

            /* Line Heights */
            --line-height-tight: 1.2;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.75;

            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
            --space-3xl: 64px;

            /* Borders & Radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;
            --border-width: 1px;

            /* Animation Timing */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 350ms ease;
            --transition-bounce: 400ms cubic-bezier(0.34, 1.56, 0.64, 1);

            /* Z-Index Layers */
            --z-base: 1;
            --z-dropdown: 100;
            --z-sticky: 200;
            --z-modal: 300;
            --z-tooltip: 400;
        }

        body {
            font-family: var(--font-family);
            background: var(--light-bg-gradient);
            background-attachment: fixed;
            color: var(--text-dark);
            line-height: var(--line-height-normal);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Google Font Import */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        /* Animation Keyframes */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes drawLine {
            to { stroke-dashoffset: 0; }
        }

        .animate-fade-in { animation: fadeIn var(--transition-slow) ease forwards; }
        .animate-fade-in-up { animation: fadeInUp var(--transition-slow) ease forwards; }
        .animate-slide-in { animation: slideInRight var(--transition-slow) ease forwards; }
        .animate-scale-in { animation: scaleIn var(--transition-bounce) forwards; }

        /* Staggered Animation Classes */
        .stagger-1 { animation-delay: 50ms; }
        .stagger-2 { animation-delay: 100ms; }
        .stagger-3 { animation-delay: 150ms; }
        .stagger-4 { animation-delay: 200ms; }
        .stagger-5 { animation-delay: 250ms; }
        .stagger-6 { animation-delay: 300ms; }

        /* Header */
        .header {
            background: var(--white);
            padding: 20px 48px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-md);
            position: relative;
            z-index: 50;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--navy) 0%, var(--steel-blue) 50%, var(--navy) 100%);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .logo-container {
            background: var(--white);
            padding: 8px;
        }

        .logo-container img {
            height: 60px;
            width: auto;
            max-width: 200px;
            object-fit: contain;
        }

        .header-text h1 {
            font-size: var(--font-h1);
            font-weight: var(--weight-bold);
            color: var(--navy);
        }

        .header-text p {
            color: var(--text-muted);
            font-size: var(--font-body);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
        }

        /* Mode Toggle (C-Overview / M-Depth) */
        .mode-toggle {
            display: flex;
            background: var(--light-bg);
            border-radius: var(--radius-full);
            padding: 4px;
            border: 1px solid var(--border-light);
        }

        .mode-toggle-btn {
            padding: 10px 24px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: var(--font-body-sm);
            font-weight: var(--weight-semibold);
            cursor: pointer;
            border-radius: var(--radius-full);
            transition: all var(--transition-normal);
        }

        .mode-toggle-btn:hover {
            color: var(--navy);
        }

        .mode-toggle-btn.active {
            background: var(--navy);
            color: var(--white);
            box-shadow: var(--shadow-sm);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 4px;
            padding: 0 48px;
            background: var(--white);
            border-bottom: 1px solid var(--light-steel);
            position: sticky;
            top: 0;
            z-index: 40;
            box-shadow: var(--shadow-sm);
        }

        .tab-btn {
            padding: 16px 28px;
            color: var(--text-muted);
            font-size: var(--font-body);
            font-weight: var(--weight-medium);
            cursor: pointer;
            border: none;
            background: transparent;
            border-bottom: 3px solid transparent;
            transition: all var(--transition-normal);
            position: relative;
        }

        .tab-btn:hover {
            color: var(--navy);
            background: var(--light-bg);
        }

        .tab-btn.active {
            color: var(--navy);
            border-bottom-color: var(--steel-blue);
            font-weight: var(--weight-semibold);
            background: linear-gradient(180deg, transparent 0%, rgba(59, 130, 246, 0.05) 100%);
        }

        /* Main Content */
        .main {
            padding: 32px 48px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Filter Row */
        .filter-row {
            display: flex;
            gap: 20px;
            margin-bottom: 28px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .filter-group label {
            font-size: var(--font-label);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: var(--weight-semibold);
        }

        .filter-select {
            background: var(--white);
            border: 2px solid var(--light-steel);
            color: var(--navy);
            padding: 14px 48px 14px 18px;
            border-radius: var(--radius-md);
            font-size: var(--font-body);
            font-weight: var(--weight-semibold);
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%231B365D' viewBox='0 0 16 16'%3E%3Cpath d='M8 12L2 6h12l-6 6z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            min-width: 200px;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }

        .filter-select:hover {
            border-color: var(--steel-blue);
            box-shadow: var(--shadow-md);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--steel-blue);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--light-steel);
        }

        .section-title {
            font-size: var(--font-h2);
            font-weight: var(--weight-bold);
            color: var(--navy);
            letter-spacing: -0.3px;
            position: relative;
            padding-left: 16px;
        }

        .section-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background: linear-gradient(180deg, var(--steel-blue) 0%, var(--navy) 100%);
            border-radius: 2px;
        }

        .section-subtitle {
            color: var(--text-muted);
            font-size: var(--font-body);
        }

        /* Hero Cards */
        .hero-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .hero-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            border: 1px solid rgba(219, 234, 254, 0.8);
            border-top: 4px solid var(--navy);
            box-shadow: var(--shadow-card);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .hero-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--navy) 0%, var(--steel-blue) 100%);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .hero-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: transparent;
        }

        .hero-card:hover::before {
            opacity: 1;
        }

        .hero-card-label {
            font-size: var(--font-label);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: var(--weight-semibold);
            margin-bottom: var(--space-sm);
        }

        .hero-card-value {
            font-size: var(--font-value-xl);
            font-weight: 800;
            color: var(--navy);
            margin-bottom: var(--space-md);
            letter-spacing: -1px;
            font-variant-numeric: tabular-nums;
        }

        .hero-card-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: 6px 14px;
            border-radius: var(--radius-full);
            font-weight: var(--weight-bold);
            font-size: var(--font-body-sm);
            transition: all var(--transition-fast);
        }

        .hero-card-badge.positive {
            background: linear-gradient(135deg, var(--positive-light) 0%, rgba(16, 185, 129, 0.2) 100%);
            color: var(--positive-dark);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }

        .hero-card-badge.negative {
            background: linear-gradient(135deg, var(--negative-light) 0%, rgba(239, 68, 68, 0.2) 100%);
            color: var(--negative-dark);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
        }

        .hero-card-badge.neutral {
            background: var(--neutral-light);
            color: var(--text-muted);
        }

        .hero-card-secondary {
            margin-top: var(--space-sm);
            font-size: var(--font-caption);
            color: var(--text-muted);
        }

        /* KPI Table */
        .kpi-table {
            width: 100%;
            background: var(--white);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border-collapse: separate;
            border-spacing: 0;
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-xl);
        }

        .kpi-table th {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            padding: 18px 20px;
            text-align: center;
            font-size: var(--font-caption);
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: var(--weight-semibold);
        }

        .kpi-table th:first-child {
            text-align: left;
        }

        .kpi-table td {
            padding: 18px 20px;
            border-bottom: 1px solid rgba(219, 234, 254, 0.5);
            font-size: var(--font-body);
            text-align: center;
            transition: background var(--transition-fast);
        }

        .kpi-table tr:hover td {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.05) 0%, transparent 100%);
        }

        .kpi-name {
            font-weight: var(--weight-semibold);
            color: var(--navy);
            text-align: left !important;
        }

        .kpi-value {
            font-weight: var(--weight-bold);
            color: var(--navy);
        }

        .kpi-change {
            font-weight: var(--weight-semibold);
        }

        .kpi-change.positive { color: var(--positive); }
        .kpi-change.negative { color: var(--negative); }
        .kpi-change.neutral { color: var(--text-muted); }

        .kpi-row.row-positive { background: rgba(16, 185, 129, 0.05); }
        .kpi-row.row-warning { background: rgba(245, 158, 11, 0.05); }
        .kpi-row.row-negative { background: rgba(239, 68, 68, 0.05); }

        /* Insights Panel */
        .insights-panel {
            background: linear-gradient(135deg, var(--white) 0%, rgba(219, 234, 254, 0.3) 100%);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            border: 1px solid rgba(219, 234, 254, 0.8);
            border-left: 5px solid var(--steel-blue);
            margin-bottom: var(--space-xl);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .insights-panel::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.05) 0%, transparent 70%);
            pointer-events: none;
        }

        .insights-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .insights-title {
            font-size: var(--font-h3);
            font-weight: var(--weight-bold);
            color: var(--navy);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .insights-toggle {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            background: rgba(59, 130, 246, 0.1);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-normal);
            color: var(--steel-blue);
        }

        .insights-toggle:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        .insights-toggle svg {
            transition: transform var(--transition-normal);
        }

        .insights-panel.collapsed .insights-toggle svg {
            transform: rotate(-90deg);
        }

        .insights-content {
            margin-top: var(--space-lg);
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 1000px;
            opacity: 1;
        }

        .insights-panel.collapsed .insights-content {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }

        .insight-row {
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
            padding: var(--space-md);
            background: var(--white);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-sm);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-normal);
        }

        .insight-row:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }

        .insight-icon {
            font-size: var(--font-body-lg);
            flex-shrink: 0;
        }

        .insight-text {
            font-size: var(--font-body);
            color: var(--text-dark);
            line-height: var(--line-height-normal);
        }

        .insights-empty {
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
            padding: var(--space-lg);
        }

        /* Market Comparison Bars */
        .market-bars {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .market-bar-row {
            display: grid;
            grid-template-columns: 150px 1fr 120px;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            background: var(--white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
        }

        .market-bar-label {
            font-weight: var(--weight-semibold);
            color: var(--navy);
        }

        .market-bar-container {
            height: 24px;
            background: var(--neutral-light);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .market-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--navy) 0%, var(--steel-blue) 100%);
            border-radius: var(--radius-sm);
            transition: width var(--transition-slow);
        }

        .market-bar-badge {
            font-weight: var(--weight-semibold);
            font-size: var(--font-caption);
            padding: 4px 10px;
            border-radius: var(--radius-full);
        }

        .market-bar-badge.positive {
            background: var(--positive-light);
            color: var(--positive-dark);
        }

        .market-bar-badge.negative {
            background: var(--negative-light);
            color: var(--negative-dark);
        }

        .market-bar-badge.neutral {
            background: var(--neutral-light);
            color: var(--text-muted);
        }

        /* Heatmap */
        .heatmap {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-xl);
            overflow-x: auto;
        }

        .heatmap-title {
            font-size: var(--font-h3);
            font-weight: var(--weight-bold);
            color: var(--navy);
            margin-bottom: var(--space-lg);
        }

        .heatmap-grid {
            display: grid;
            gap: var(--space-xs);
        }

        .heatmap-row {
            display: flex;
            gap: var(--space-xs);
        }

        .heatmap-header {
            width: 150px;
            padding: var(--space-sm);
            font-weight: var(--weight-semibold);
            color: var(--navy);
            display: flex;
            align-items: center;
        }

        .heatmap-cell {
            width: 80px;
            height: 48px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--weight-semibold);
            font-size: var(--font-caption);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .heatmap-cell:hover {
            transform: scale(1.05);
        }

        .heatmap-positive {
            background: var(--positive-light);
            color: var(--positive-dark);
        }

        .heatmap-warning {
            background: var(--warning-light);
            color: var(--warning-dark);
        }

        .heatmap-negative {
            background: var(--negative-light);
            color: var(--negative-dark);
        }

        .heatmap-neutral {
            background: var(--neutral-light);
            color: var(--text-muted);
        }

        /* Trend Chart */
        .trend-chart {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-xl);
        }

        .trend-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
        }

        .trend-chart-title {
            font-size: var(--font-h3);
            font-weight: var(--weight-bold);
            color: var(--navy);
        }

        .trend-legend {
            display: flex;
            gap: var(--space-lg);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: var(--font-caption);
            color: var(--text-muted);
        }

        .legend-dot {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        .legend-dot.current { background: var(--navy); }
        .legend-dot.lastyear { background: var(--text-muted); stroke-dasharray: 5, 5; }
        .legend-dot.target { background: var(--positive); }

        .chart-svg {
            width: 100%;
            height: 300px;
        }

        .chart-dot {
            cursor: pointer;
            transition: r var(--transition-fast);
        }

        .chart-dot:hover {
            r: 8;
        }

        /* Chart Tooltip */
        .chart-tooltip {
            position: fixed;
            background: var(--navy);
            color: var(--white);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            font-size: var(--font-caption);
            pointer-events: none;
            opacity: 0;
            transition: opacity var(--transition-fast);
            z-index: var(--z-tooltip);
            box-shadow: var(--shadow-lg);
        }

        .chart-tooltip.visible {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: var(--weight-bold);
            margin-bottom: var(--space-sm);
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: var(--space-md);
        }

        .tooltip-label {
            color: var(--text-light);
        }

        .tooltip-value {
            font-weight: var(--weight-semibold);
        }

        /* Upload Screen */
        .upload-overlay {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-xl);
        }

        .upload-box {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            max-width: 600px;
            width: 100%;
            box-shadow: var(--shadow-xl);
            text-align: center;
        }

        .upload-logo {
            margin-bottom: var(--space-lg);
        }

        .upload-logo img {
            height: 80px;
            width: auto;
        }

        .upload-box h2 {
            font-size: var(--font-h2);
            color: var(--navy);
            margin-bottom: var(--space-sm);
        }

        .upload-box > p {
            color: var(--text-muted);
            margin-bottom: var(--space-xl);
        }

        .upload-zone {
            border: 2px dashed var(--border-medium);
            border-radius: var(--radius-lg);
            padding: var(--space-2xl);
            margin-bottom: var(--space-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .upload-zone:hover {
            border-color: var(--steel-blue);
            background: rgba(59, 130, 246, 0.05);
        }

        .upload-zone-icon {
            font-size: 48px;
            margin-bottom: var(--space-md);
        }

        .upload-zone-text {
            color: var(--text-muted);
        }

        .upload-zone-file {
            color: var(--positive);
            font-weight: var(--weight-semibold);
        }

        .upload-hint {
            font-size: var(--font-caption);
            color: var(--text-muted);
            margin-bottom: var(--space-lg);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            color: var(--white);
            padding: 14px 32px;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-body);
            font-weight: var(--weight-semibold);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .demo-btn {
            margin-top: var(--space-md);
            background: transparent;
            border: none;
            color: var(--steel-blue);
            font-size: var(--font-caption);
            cursor: pointer;
            text-decoration: underline;
        }

        /* M-Depth Placeholder */
        .placeholder-panel {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-3xl);
            text-align: center;
            box-shadow: var(--shadow-md);
        }

        .placeholder-icon {
            font-size: 64px;
            margin-bottom: var(--space-lg);
        }

        .placeholder-title {
            font-size: var(--font-h2);
            color: var(--navy);
            margin-bottom: var(--space-sm);
        }

        .placeholder-text {
            color: var(--text-muted);
            max-width: 400px;
            margin: 0 auto;
        }

        /* Data Timestamp */
        .data-timestamp {
            position: fixed;
            bottom: 24px;
            left: 24px;
            background: var(--white);
            padding: 10px 16px;
            border-radius: var(--radius-full);
            font-size: var(--font-caption);
            color: var(--text-muted);
            box-shadow: var(--shadow-md);
            z-index: var(--z-dropdown);
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div class="chart-tooltip" id="chartTooltip"></div>

    <script>
    (function() {
        'use strict';

        // ============================================================================
        // CONSTANTS
        // ============================================================================

        const MONTHS = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
        const MONTH_LABELS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        const CURRENT_YEAR = 2025;
        const PREVIOUS_YEAR = 2024;

        // KPI Configuration (MUSE only)
        const KPI_CONFIG = {
            'SLS_TTL': { name: 'Total Sales', format: 'C0', category: 'sales' },
            'SLS_PEN': { name: 'Sales Penetration', format: 'P4', category: 'sales' },
            'MBR_TTL': { name: 'Transacting Members', format: 'V0', category: 'members' },
            'MBR_NEW': { name: 'New Members', format: 'V0', category: 'members' },
            'MBR_RTN': { name: 'Returning Members', format: 'V0', category: 'members' },
            'AVG_ATF': { name: 'Average Frequency', format: 'V2', category: 'behavior' },
            'AVG_AOV': { name: 'Average Order Value', format: 'C0', category: 'behavior' },
            'PCT_RDM': { name: 'Redeeming Members %', format: 'P4', category: 'loyalty' },
            'PCT_XBP': { name: 'Cross Brand Plus %', format: 'P4', category: 'crossbrand' },
            'PCT_NBA': { name: 'New Brand Adopters %', format: 'P4', category: 'crossbrand' },
            'AVG_BRD': { name: 'Avg Brands Shopped', format: 'V2', category: 'crossbrand' },
            'PTS_BRN': { name: 'Points Burned Value', format: 'C0', category: 'loyalty' }
        };

        const HERO_KPIS = ['SLS_TTL', 'MBR_TTL', 'PCT_XBP', 'SLS_PEN'];
        const SCORECARD_KPIS = ['SLS_TTL', 'SLS_PEN', 'MBR_TTL', 'MBR_NEW', 'MBR_RTN', 'AVG_ATF', 'AVG_AOV', 'PCT_RDM', 'PCT_XBP', 'PCT_NBA', 'AVG_BRD', 'PTS_BRN'];
        const HEATMAP_KPIS = ['SLS_TTL', 'MBR_TTL', 'PCT_XBP', 'PCT_RDM'];

        const LOGO_SVG = `<img src="logo.png" alt="Company Logo" style="height: 60px; width: auto;" onerror="this.style.display='none'">`;

        // ============================================================================
        // INSIGHT RULES (from INSIGHTS_ENGINE.js)
        // ============================================================================

        const INSIGHT_RULES = [
            // CRITICAL (Red) - Priority 1
            {
                id: 'sales_below_target_critical',
                severity: 'critical',
                priority: 1,
                icon: 'ðŸ”´',
                condition: function(row) {
                    return row.Key === 'SLS_TTL' &&
                           row.Market !== 'All Markets' &&
                           row.vs_Target !== null &&
                           row.vs_Target < -0.05;
                },
                message: function(row) {
                    return `${row.Market} sales ${formatPct(Math.abs(row.vs_Target))} below target â€” requires attention`;
                }
            },
            {
                id: 'members_declining_critical',
                severity: 'critical',
                priority: 1,
                icon: 'ðŸ”´',
                condition: function(row) {
                    return row.Key === 'MBR_TTL' &&
                           row.Market !== 'All Markets' &&
                           row.vs_LYTD !== null &&
                           row.vs_LYTD < -0.10;
                },
                message: function(row) {
                    return `${row.Market} members down ${formatPct(Math.abs(row.vs_LYTD))} vs last year â€” investigate churn`;
                }
            },
            {
                id: 'penetration_drop_critical',
                severity: 'critical',
                priority: 1,
                icon: 'ðŸ”´',
                condition: function(row) {
                    return row.Key === 'SLS_PEN' &&
                           row.Market !== 'All Markets' &&
                           row.vs_LYTD !== null &&
                           row.vs_LYTD < -0.02;
                },
                message: function(row) {
                    return `${row.Market} penetration dropped ${formatPP(Math.abs(row.vs_LYTD))} â€” losing market share`;
                }
            },
            // WARNING (Yellow) - Priority 2
            {
                id: 'crossbrand_declining',
                severity: 'warning',
                priority: 2,
                icon: 'ðŸŸ¡',
                condition: function(row) {
                    return row.Key === 'PCT_XBP' &&
                           row.Market !== 'All Markets' &&
                           row.vs_LYTD !== null &&
                           row.vs_LYTD < -0.01;
                },
                message: function(row) {
                    return `${row.Market} cross-brand rate declining (${formatPP(row.vs_LYTD)} vs LY) â€” review program engagement`;
                }
            },
            {
                id: 'redemption_declining',
                severity: 'warning',
                priority: 2,
                icon: 'ðŸŸ¡',
                condition: function(row) {
                    return row.Key === 'PCT_RDM' &&
                           row.Market !== 'All Markets' &&
                           row.vs_LYTD !== null &&
                           row.vs_LYTD < -0.01;
                },
                message: function(row) {
                    return `${row.Market} redemption rate down (${formatPP(row.vs_LYTD)} vs LY) â€” check reward relevance`;
                }
            },
            {
                id: 'aov_declining',
                severity: 'warning',
                priority: 2,
                icon: 'ðŸŸ¡',
                condition: function(row) {
                    return row.Key === 'AVG_AOV' &&
                           row.Market !== 'All Markets' &&
                           row.vs_LYTD !== null &&
                           row.vs_LYTD < -0.05;
                },
                message: function(row) {
                    return `${row.Market} average order value down ${formatPct(Math.abs(row.vs_LYTD))} â€” review pricing/mix`;
                }
            },
            {
                id: 'sales_slightly_below_target',
                severity: 'warning',
                priority: 2,
                icon: 'ðŸŸ¡',
                condition: function(row) {
                    return row.Key === 'SLS_TTL' &&
                           row.Market !== 'All Markets' &&
                           row.vs_Target !== null &&
                           row.vs_Target >= -0.05 &&
                           row.vs_Target < 0;
                },
                message: function(row) {
                    return `${row.Market} sales ${formatPct(Math.abs(row.vs_Target))} below target â€” monitor closely`;
                }
            },
            // POSITIVE (Green) - Priority 3
            {
                id: 'sales_beating_target',
                severity: 'positive',
                priority: 3,
                icon: 'ðŸŸ¢',
                condition: function(row) {
                    return row.Key === 'SLS_TTL' &&
                           row.Market !== 'All Markets' &&
                           row.vs_Target !== null &&
                           row.vs_Target > 0.05;
                },
                message: function(row) {
                    return `${row.Market} sales ${formatPct(row.vs_Target)} above target â€” strong performance`;
                }
            },
            {
                id: 'crossbrand_high',
                severity: 'positive',
                priority: 3,
                icon: 'ðŸŸ¢',
                condition: function(row) {
                    return row.Key === 'PCT_XBP' &&
                           row.Market !== 'All Markets' &&
                           row.YTD > 0.25 &&
                           row.vs_LYTD !== null &&
                           row.vs_LYTD > 0.01;
                },
                message: function(row) {
                    return `${row.Market} cross-brand rate at ${formatPct(row.YTD)} (+${formatPP(row.vs_LYTD)} vs LY) â€” program success`;
                }
            },
            {
                id: 'new_members_surge',
                severity: 'positive',
                priority: 3,
                icon: 'ðŸŸ¢',
                condition: function(row) {
                    return row.Key === 'MBR_NEW' &&
                           row.Market !== 'All Markets' &&
                           row.vs_LYTD !== null &&
                           row.vs_LYTD > 0.15;
                },
                message: function(row) {
                    return `${row.Market} new member acquisition up ${formatPct(row.vs_LYTD)} â€” growth momentum`;
                }
            },
            {
                id: 'sales_strong_growth',
                severity: 'positive',
                priority: 3,
                icon: 'ðŸŸ¢',
                condition: function(row) {
                    return row.Key === 'SLS_TTL' &&
                           row.Market !== 'All Markets' &&
                           row.vs_LYTD !== null &&
                           row.vs_LYTD > 0.15;
                },
                message: function(row) {
                    return `${row.Market} sales up ${formatPct(row.vs_LYTD)} vs last year â€” excellent growth`;
                }
            }
        ];

        // ============================================================================
        // STATE
        // ============================================================================

        const state = {
            // Dashboard mode (C-Overview or M-Depth)
            dashboardMode: 'C-OVERVIEW',     // 'C-OVERVIEW' | 'M-DEPTH'
            comparisonMode: 'LYTD',          // 'LYTD' | 'Target' | 'LMR12M'
            activeTab: 'scorecard',          // 'scorecard' | 'markets' | 'trends'
            insightsPanelExpanded: true,

            // Data state
            dataLoaded: false,

            // Data stores (MUSE only)
            museData: null,
            museTrendData: null,
            museFileName: null,

            // Filters
            selectedMonth: null,
            selectedMarket: 'All Markets',
            selectedKPI: 'SLS_TTL'
        };

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================

        // Safe division to avoid divide-by-zero
        function safeDiv(numerator, denominator, fallback = 0) {
            if (denominator === null || denominator === undefined ||
                denominator === 0 || Number.isNaN(denominator)) {
                return fallback;
            }
            return numerator / denominator;
        }

        // Format value for display
        function formatValue(value, format) {
            if (value === null || value === undefined || Number.isNaN(value)) {
                return 'â€”';
            }

            const num = Number(value);

            switch (format) {
                case 'C0':
                    if (Math.abs(num) >= 1000000) {
                        return '$' + (num / 1000000).toFixed(1) + 'M';
                    } else if (Math.abs(num) >= 1000) {
                        return '$' + (num / 1000).toFixed(1) + 'K';
                    }
                    return '$' + num.toLocaleString('en-US', { maximumFractionDigits: 0 });

                case 'C2':
                    return '$' + num.toFixed(2);

                case 'V0':
                    if (Math.abs(num) >= 1000000) {
                        return (num / 1000000).toFixed(1) + 'M';
                    } else if (Math.abs(num) >= 1000) {
                        return (num / 1000).toFixed(1) + 'K';
                    }
                    return num.toLocaleString('en-US', { maximumFractionDigits: 0 });

                case 'V2':
                    return num.toFixed(2);

                case 'P4':
                    return (num * 100).toFixed(1) + '%';

                default:
                    return String(num);
            }
        }

        // Format change/variance for display
        function formatChange(value, format) {
            if (value === null || value === undefined || Number.isNaN(value)) {
                return 'â€”';
            }

            const num = Number(value);
            const sign = num >= 0 ? '+' : '';
            const arrow = num >= 0 ? 'â–²' : 'â–¼';

            // Percentage point formats (P*)
            if (format && format.startsWith('P')) {
                return `${arrow} ${sign}${(num * 100).toFixed(1)}pp`;
            }

            // Regular percentage change
            return `${arrow} ${sign}${(num * 100).toFixed(1)}%`;
        }

        // Format percentage for insights
        function formatPct(value) {
            if (value === null || value === undefined) return 'â€”';
            return (value * 100).toFixed(1) + '%';
        }

        // Format percentage points for insights
        function formatPP(value) {
            if (value === null || value === undefined) return 'â€”';
            const sign = value >= 0 ? '+' : '';
            return sign + (value * 100).toFixed(1) + 'pp';
        }

        // Get variance based on comparison mode
        function getVariance(row, comparisonMode) {
            if (!row) return null;

            switch (comparisonMode) {
                case 'LYTD': return row.vs_LYTD;
                case 'Target': return row.vs_Target;
                case 'LMR12M': return row.vs_LMR12M;
                default: return null;
            }
        }

        // Get comparison label
        function getComparisonLabel(comparisonMode) {
            switch (comparisonMode) {
                case 'LYTD': return 'vs LY';
                case 'Target': return 'vs Target';
                case 'LMR12M': return 'vs R12M';
                default: return '';
            }
        }

        // Get badge class based on variance
        function getBadgeClass(variance, format) {
            if (variance === null || variance === undefined) return 'neutral';

            // Percentage point metrics
            if (format && format.startsWith('P')) {
                if (variance > 0.005) return 'positive';
                if (variance < -0.005) return 'negative';
                return 'neutral';
            }

            // Percentage change metrics
            if (variance > 0.02) return 'positive';
            if (variance < -0.02) return 'negative';
            return 'neutral';
        }

        // Get row class based on vs_Target
        function getRowClass(variance) {
            if (variance === null || variance === undefined) return '';
            if (variance >= 0) return 'row-positive';
            if (variance >= -0.05) return 'row-warning';
            return 'row-negative';
        }

        // Get heatmap cell class
        function getHeatmapClass(vsTarget) {
            if (vsTarget === null || vsTarget === undefined) return 'heatmap-neutral';
            if (vsTarget >= 0) return 'heatmap-positive';
            if (vsTarget >= -0.05) return 'heatmap-warning';
            return 'heatmap-negative';
        }

        // ============================================================================
        // DYNAMIC DIMENSION EXTRACTION (Critical - no hardcoding)
        // ============================================================================

        function getUniqueDimensionValues(data, dimension) {
            return [...new Set(data.map(row => row[dimension]))]
                .filter(v => v !== null && v !== undefined && v !== '')
                .sort();
        }

        function getMarkets(data) {
            if (!data) return [];
            const markets = getUniqueDimensionValues(data, 'Market');
            // Sort with "All Markets" first
            return markets.sort((a, b) => {
                if (a === 'All Markets') return -1;
                if (b === 'All Markets') return 1;
                return a.localeCompare(b);
            });
        }

        function getMonths(data) {
            if (!data) return [];
            return getUniqueDimensionValues(data, 'Month').sort();
        }

        function getLatestMonth(data) {
            const months = getMonths(data);
            return months[months.length - 1] || null;
        }

        function getKPIs(data) {
            if (!data) return [];
            return getUniqueDimensionValues(data, 'Key').filter(k => KPI_CONFIG[k]);
        }

        // ============================================================================
        // DATA FUNCTIONS
        // ============================================================================

        function getData() {
            return state.museData;
        }

        function getKPIRow(data, kpiKey, market, month) {
            return data.find(r =>
                r.Key === kpiKey &&
                r.Market === market &&
                r.Month === month
            ) || null;
        }

        function filterData(data, { month, market, kpiKey }) {
            return data.filter(row => {
                if (month && row.Month !== month) return false;
                if (market && row.Market !== market) return false;
                if (kpiKey && row.Key !== kpiKey) return false;
                return true;
            });
        }

        function getMarketsForKPI(data, kpiKey, month) {
            return data.filter(r =>
                r.Key === kpiKey &&
                r.Month === month &&
                r.Market !== 'All Markets'
            );
        }

        // ============================================================================
        // CSV PARSING
        // ============================================================================

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',');

            const numericColumns = [
                'YTD', 'LYTD', 'Target', 'R12M', 'LMR12M', 'LYR12M',
                'vs_Target', 'vs_LYTD', 'vs_LMR12M', 'vs_LYR12M'
            ];

            return lines.slice(1).map(line => {
                const values = line.split(',');
                const row = {};

                headers.forEach((header, i) => {
                    let value = values[i];

                    // Parse numeric columns
                    if (numericColumns.includes(header) || header.match(/^M\d{2}_/)) {
                        value = value === '' || value === 'null' || value === undefined ? null : parseFloat(value);
                    }

                    row[header] = value;
                });

                return row;
            });
        }

        // ============================================================================
        // INSIGHTS GENERATION
        // ============================================================================

        function generateInsights(data, month) {
            if (!data || !month) return [];

            const insights = [];
            const seen = new Set();

            const monthData = data.filter(row => row.Month === month);

            for (const row of monthData) {
                for (const rule of INSIGHT_RULES) {
                    try {
                        if (rule.condition(row)) {
                            const key = `${rule.id}_${row.Market}`;
                            if (seen.has(key)) continue;
                            seen.add(key);

                            insights.push({
                                id: rule.id,
                                severity: rule.severity,
                                priority: rule.priority,
                                icon: rule.icon,
                                message: rule.message(row),
                                market: row.Market,
                                kpi: row.Key
                            });
                        }
                    } catch (e) {
                        console.warn(`Insight rule ${rule.id} error:`, e);
                    }
                }
            }

            const severityOrder = { critical: 1, warning: 2, positive: 3, info: 4 };

            insights.sort((a, b) => {
                if (a.priority !== b.priority) return a.priority - b.priority;
                return severityOrder[a.severity] - severityOrder[b.severity];
            });

            return insights.slice(0, 5);
        }

        // ============================================================================
        // RENDER FUNCTIONS
        // ============================================================================

        function render() {
            const app = document.getElementById('app');
            if (!state.dataLoaded) {
                app.innerHTML = renderUpload();
            } else {
                app.innerHTML = renderDashboard();
            }
            attachEventListeners();
        }

        function renderUpload() {
            const fileName = state.museFileName || '';

            return `
                <div class="upload-overlay">
                    <div class="upload-box">
                        <div class="upload-logo">${LOGO_SVG}</div>
                        <h2>MUSE Loyalty Analytics</h2>
                        <p>Upload your metrics CSV file to begin</p>

                        <div class="upload-zone" id="uploadZone">
                            <input type="file" id="fileInput" accept=".csv" style="display:none">
                            <div class="upload-zone-icon">ðŸ“Š</div>
                            ${fileName
                                ? `<div class="upload-zone-file">âœ“ ${fileName}</div>`
                                : '<p class="upload-zone-text">Click or drop CSV file here</p>'}
                        </div>

                        <p class="upload-hint">Accepts metrics_main.csv format</p>

                        <button class="btn-primary" id="startBtn" ${fileName ? '' : 'disabled'}>
                            Start Dashboard
                        </button>
                        <button class="demo-btn" id="demoBtn">Load Demo Data</button>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            return `
                ${renderHeader()}
                ${renderTabs()}
                <main class="main">
                    ${renderContent()}
                </main>
                <div class="data-timestamp">ðŸ“Š Data refreshed: ${state.museData?.[0]?.Refresh_Date || 'N/A'}</div>
            `;
        }

        function renderHeader() {
            return `
                <header class="header">
                    <div class="header-left">
                        <div class="logo-container">${LOGO_SVG}</div>
                        <div class="header-text">
                            <h1>MUSE Loyalty Analytics</h1>
                            <p>${CURRENT_YEAR} Performance Dashboard</p>
                        </div>
                    </div>
                    <div class="header-right">
                        ${renderModeToggle()}
                    </div>
                </header>
            `;
        }

        function renderModeToggle() {
            return `
                <div class="mode-toggle">
                    <button class="mode-toggle-btn ${state.dashboardMode === 'C-OVERVIEW' ? 'active' : ''}"
                            data-mode="C-OVERVIEW">
                        C-Overview
                    </button>
                    <button class="mode-toggle-btn ${state.dashboardMode === 'M-DEPTH' ? 'active' : ''}"
                            data-mode="M-DEPTH">
                        M-Depth
                    </button>
                </div>
            `;
        }

        function renderTabs() {
            if (state.dashboardMode === 'M-DEPTH') {
                return `<nav class="nav-tabs">
                    <button class="tab-btn active">M-Depth Mode</button>
                </nav>`;
            }

            return `
                <nav class="nav-tabs">
                    <button class="tab-btn ${state.activeTab === 'scorecard' ? 'active' : ''}" data-tab="scorecard">
                        Executive Scorecard
                    </button>
                    <button class="tab-btn ${state.activeTab === 'markets' ? 'active' : ''}" data-tab="markets">
                        Market Performance
                    </button>
                    <button class="tab-btn ${state.activeTab === 'trends' ? 'active' : ''}" data-tab="trends">
                        Trends
                    </button>
                </nav>
            `;
        }

        function renderContent() {
            if (state.dashboardMode === 'M-DEPTH') {
                return renderMDepthPlaceholder();
            }

            switch (state.activeTab) {
                case 'scorecard': return renderScorecard();
                case 'markets': return renderMarkets();
                case 'trends': return renderTrends();
                default: return renderScorecard();
            }
        }

        function renderMDepthPlaceholder() {
            return `
                <div class="placeholder-panel animate-fade-in">
                    <div class="placeholder-icon">ðŸ”¬</div>
                    <h2 class="placeholder-title">M-Depth Mode</h2>
                    <p class="placeholder-text">
                        Marketing deep-dive analysis coming soon. This mode will include brand drill-downs,
                        cross-brand flow analysis, and dimensional exploration.
                    </p>
                </div>
            `;
        }

        // ============================================================================
        // SCORECARD TAB
        // ============================================================================

        function renderScorecard() {
            const data = getData();
            const month = state.selectedMonth || getLatestMonth(data);
            const market = state.selectedMarket;
            const insights = generateInsights(data, month);

            return `
                ${renderFilters()}
                <div class="section-header">
                    <div>
                        <div class="section-title">Executive Scorecard</div>
                        <div class="section-subtitle">YTD ${CURRENT_YEAR} | ${market} | ${month}</div>
                    </div>
                </div>
                ${renderHeroCards(data, month, market)}
                ${renderInsightsPanel(insights)}
                ${renderKPITable(data, month, market)}
            `;
        }

        function renderFilters() {
            const data = getData();
            const months = getMonths(data);
            const markets = getMarkets(data);
            const currentMonth = state.selectedMonth || getLatestMonth(data);

            return `
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Month</label>
                        <select class="filter-select" id="monthSelect">
                            ${months.map(m => `
                                <option value="${m}" ${m === currentMonth ? 'selected' : ''}>${m}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Market</label>
                        <select class="filter-select" id="marketSelect">
                            ${markets.map(m => `
                                <option value="${m}" ${m === state.selectedMarket ? 'selected' : ''}>${m}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Compare To</label>
                        <select class="filter-select" id="comparisonSelect">
                            <option value="LYTD" ${state.comparisonMode === 'LYTD' ? 'selected' : ''}>vs Last Year</option>
                            <option value="Target" ${state.comparisonMode === 'Target' ? 'selected' : ''}>vs Target</option>
                            <option value="LMR12M" ${state.comparisonMode === 'LMR12M' ? 'selected' : ''}>vs R12M</option>
                        </select>
                    </div>
                </div>
            `;
        }

        function renderHeroCards(data, month, market) {
            const cards = HERO_KPIS.map((kpiKey, i) => {
                const row = getKPIRow(data, kpiKey, market, month);
                const config = KPI_CONFIG[kpiKey];

                if (!row) {
                    return `<div class="hero-card hero-card-empty animate-fade-in-up stagger-${i+1}">No data</div>`;
                }

                const variance = getVariance(row, state.comparisonMode);
                const badgeClass = getBadgeClass(variance, row.Format);

                return `
                    <div class="hero-card animate-fade-in-up stagger-${i+1}">
                        <div class="hero-card-label">${config.name.toUpperCase()}</div>
                        <div class="hero-card-value">${formatValue(row.YTD, row.Format)}</div>
                        <div class="hero-card-badge ${badgeClass}">
                            ${formatChange(variance, row.Format)} ${getComparisonLabel(state.comparisonMode)}
                        </div>
                        ${row.Target ? `
                            <div class="hero-card-secondary">
                                Target: ${formatValue(row.Target, row.Format)}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            return `<div class="hero-cards">${cards}</div>`;
        }

        function renderInsightsPanel(insights) {
            const insightRows = insights.length > 0
                ? insights.map(insight => `
                    <div class="insight-row">
                        <span class="insight-icon">${insight.icon}</span>
                        <span class="insight-text">${insight.message}</span>
                    </div>
                `).join('')
                : '<div class="insights-empty">No notable insights for this period.</div>';

            return `
                <div class="insights-panel ${state.insightsPanelExpanded ? '' : 'collapsed'}" id="insightsPanel">
                    <div class="insights-header" id="insightsHeader">
                        <span class="insights-title">ðŸ“Š Key Insights</span>
                        <button class="insights-toggle" aria-label="Toggle insights">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="4 6 8 10 12 6"></polyline>
                            </svg>
                        </button>
                    </div>
                    <div class="insights-content">
                        ${insightRows}
                    </div>
                </div>
            `;
        }

        function renderKPITable(data, month, market) {
            const rows = SCORECARD_KPIS.map(kpiKey => {
                const row = getKPIRow(data, kpiKey, market, month);
                const config = KPI_CONFIG[kpiKey];

                if (!row) return '';

                const vsTargetClass = getBadgeClass(row.vs_Target, row.Format);
                const vsLYClass = getBadgeClass(row.vs_LYTD, row.Format);
                const rowClass = getRowClass(row.vs_Target);

                return `
                    <tr class="kpi-row ${rowClass}">
                        <td class="kpi-name">${config.name}</td>
                        <td class="kpi-value">${formatValue(row.YTD, row.Format)}</td>
                        <td class="kpi-value">${formatValue(row.Target, row.Format)}</td>
                        <td class="kpi-change ${vsTargetClass}">${formatChange(row.vs_Target, row.Format)}</td>
                        <td class="kpi-value">${formatValue(row.LYTD, row.Format)}</td>
                        <td class="kpi-change ${vsLYClass}">${formatChange(row.vs_LYTD, row.Format)}</td>
                    </tr>
                `;
            }).join('');

            return `
                <table class="kpi-table">
                    <thead>
                        <tr>
                            <th>KPI</th>
                            <th>YTD</th>
                            <th>Target</th>
                            <th>vs Target</th>
                            <th>LYTD</th>
                            <th>vs LY</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
        }

        // ============================================================================
        // MARKETS TAB
        // ============================================================================

        function renderMarkets() {
            const data = getData();
            const month = state.selectedMonth || getLatestMonth(data);
            const kpis = getKPIs(data);

            return `
                ${renderMarketsFilters(kpis)}
                <div class="section-header">
                    <div>
                        <div class="section-title">Market Performance</div>
                        <div class="section-subtitle">${KPI_CONFIG[state.selectedKPI]?.name || state.selectedKPI} | ${month}</div>
                    </div>
                </div>
                ${renderMarketBars(data, month, state.selectedKPI)}
                ${renderHeatmap(data, month)}
            `;
        }

        function renderMarketsFilters(kpis) {
            const data = getData();
            const months = getMonths(data);
            const currentMonth = state.selectedMonth || getLatestMonth(data);

            return `
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Month</label>
                        <select class="filter-select" id="monthSelect">
                            ${months.map(m => `
                                <option value="${m}" ${m === currentMonth ? 'selected' : ''}>${m}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>KPI</label>
                        <select class="filter-select" id="kpiSelect">
                            ${kpis.map(k => `
                                <option value="${k}" ${k === state.selectedKPI ? 'selected' : ''}>${KPI_CONFIG[k]?.name || k}</option>
                            `).join('')}
                        </select>
                    </div>
                </div>
            `;
        }

        function renderMarketBars(data, month, kpiKey) {
            const marketsData = getMarketsForKPI(data, kpiKey, month);

            if (marketsData.length === 0) {
                return '<div class="insights-empty">No market data available</div>';
            }

            // Sort by value descending
            marketsData.sort((a, b) => (b.YTD || 0) - (a.YTD || 0));

            // Find max for scaling
            const maxValue = Math.max(...marketsData.map(r => r.YTD || 0));

            const bars = marketsData.map(row => {
                const config = KPI_CONFIG[kpiKey];
                const width = safeDiv(row.YTD, maxValue, 0) * 100;
                const variance = getVariance(row, state.comparisonMode);
                const badgeClass = getBadgeClass(variance, row.Format);

                return `
                    <div class="market-bar-row">
                        <div class="market-bar-label">${row.Market}</div>
                        <div class="market-bar-container">
                            <div class="market-bar-fill" style="width: ${width}%"></div>
                        </div>
                        <div class="market-bar-badge ${badgeClass}">
                            ${formatChange(variance, row.Format)}
                        </div>
                    </div>
                `;
            }).join('');

            return `<div class="market-bars animate-fade-in">${bars}</div>`;
        }

        function renderHeatmap(data, month) {
            const markets = getMarkets(data).filter(m => m !== 'All Markets');

            if (markets.length === 0) {
                return '';
            }

            // Header row
            const headerCells = markets.map(m =>
                `<div class="heatmap-cell" style="background: var(--navy); color: white; font-size: 10px;">${m.substring(0, 6)}</div>`
            ).join('');

            // Data rows
            const rows = HEATMAP_KPIS.map(kpiKey => {
                const config = KPI_CONFIG[kpiKey];
                const cells = markets.map(market => {
                    const row = getKPIRow(data, kpiKey, market, month);
                    if (!row) return `<div class="heatmap-cell heatmap-neutral">â€”</div>`;

                    const cellClass = getHeatmapClass(row.vs_Target);
                    const displayValue = formatChange(row.vs_Target, row.Format);

                    return `<div class="heatmap-cell ${cellClass}" title="${market}: ${displayValue}">${displayValue}</div>`;
                }).join('');

                return `
                    <div class="heatmap-row">
                        <div class="heatmap-header">${config.name}</div>
                        ${cells}
                    </div>
                `;
            }).join('');

            return `
                <div class="heatmap">
                    <div class="heatmap-title">Performance vs Target Heatmap</div>
                    <div class="heatmap-grid">
                        <div class="heatmap-row">
                            <div class="heatmap-header"></div>
                            ${headerCells}
                        </div>
                        ${rows}
                    </div>
                </div>
            `;
        }

        // ============================================================================
        // TRENDS TAB
        // ============================================================================

        function renderTrends() {
            const data = getData();
            const trendData = state.museTrendData;
            const kpis = getKPIs(data);
            const markets = getMarkets(data);

            return `
                ${renderTrendsFilters(kpis, markets)}
                <div class="section-header">
                    <div>
                        <div class="section-title">Trend Analysis</div>
                        <div class="section-subtitle">${KPI_CONFIG[state.selectedKPI]?.name || state.selectedKPI} | ${state.selectedMarket}</div>
                    </div>
                </div>
                ${trendData ? renderTrendChart(trendData) : renderTrendPlaceholder()}
            `;
        }

        function renderTrendsFilters(kpis, markets) {
            return `
                <div class="filter-row">
                    <div class="filter-group">
                        <label>KPI</label>
                        <select class="filter-select" id="kpiSelect">
                            ${kpis.map(k => `
                                <option value="${k}" ${k === state.selectedKPI ? 'selected' : ''}>${KPI_CONFIG[k]?.name || k}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Market</label>
                        <select class="filter-select" id="marketSelect">
                            ${markets.map(m => `
                                <option value="${m}" ${m === state.selectedMarket ? 'selected' : ''}>${m}</option>
                            `).join('')}
                        </select>
                    </div>
                </div>
            `;
        }

        function renderTrendChart(trendData) {
            const row = trendData.find(r =>
                r.Key === state.selectedKPI &&
                r.Market === state.selectedMarket
            );

            if (!row) {
                return renderTrendPlaceholder();
            }

            const config = KPI_CONFIG[state.selectedKPI];
            const months = [];

            // Extract monthly values
            for (let i = 1; i <= 12; i++) {
                const m = String(i).padStart(2, '0');
                months.push({
                    month: i,
                    label: MONTH_LABELS[i - 1],
                    ytd: row[`M${m}_YTD`],
                    lytd: row[`M${m}_LYTD`],
                    target: row[`M${m}_Target`]
                });
            }

            // Filter out months with no data
            const validMonths = months.filter(m => m.ytd !== null && m.ytd !== undefined);

            if (validMonths.length === 0) {
                return renderTrendPlaceholder();
            }

            // Chart dimensions
            const width = 800;
            const height = 300;
            const padding = { top: 20, right: 20, bottom: 40, left: 60 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            // Calculate scales
            const allValues = validMonths.flatMap(m => [m.ytd, m.lytd, m.target].filter(v => v !== null));
            const minVal = Math.min(...allValues) * 0.9;
            const maxVal = Math.max(...allValues) * 1.1;

            const xScale = (i) => padding.left + (i / (validMonths.length - 1)) * chartWidth;
            const yScale = (v) => padding.top + chartHeight - ((v - minVal) / (maxVal - minVal)) * chartHeight;

            // Generate paths
            const ytdPath = validMonths.map((m, i) =>
                `${i === 0 ? 'M' : 'L'} ${xScale(i)} ${yScale(m.ytd)}`
            ).join(' ');

            const lytdPath = validMonths.map((m, i) =>
                `${i === 0 ? 'M' : 'L'} ${xScale(i)} ${yScale(m.lytd)}`
            ).join(' ');

            const targetPath = validMonths.filter(m => m.target !== null).map((m, i) =>
                `${i === 0 ? 'M' : 'L'} ${xScale(validMonths.indexOf(m))} ${yScale(m.target)}`
            ).join(' ');

            // Generate dots
            const dots = validMonths.map((m, i) => `
                <circle class="chart-dot" cx="${xScale(i)}" cy="${yScale(m.ytd)}" r="5" fill="var(--navy)"
                    data-info='${JSON.stringify({ month: m.label, ytd: m.ytd, lytd: m.lytd, target: m.target, format: config.format })}'/>
            `).join('');

            // X-axis labels
            const xLabels = validMonths.map((m, i) => `
                <text x="${xScale(i)}" y="${height - 10}" text-anchor="middle" fill="var(--text-muted)" font-size="12">${m.label}</text>
            `).join('');

            // Y-axis (simple)
            const yTicks = 5;
            const yLabels = Array.from({ length: yTicks }, (_, i) => {
                const value = minVal + (maxVal - minVal) * (i / (yTicks - 1));
                const y = yScale(value);
                return `
                    <text x="${padding.left - 10}" y="${y + 4}" text-anchor="end" fill="var(--text-muted)" font-size="11">${formatValue(value, config.format)}</text>
                    <line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="var(--border-light)" stroke-dasharray="3,3"/>
                `;
            }).join('');

            return `
                <div class="trend-chart animate-fade-in">
                    <div class="trend-chart-header">
                        <div class="trend-chart-title">Monthly Trend</div>
                        <div class="trend-legend">
                            <div class="legend-item"><div class="legend-dot current"></div> ${CURRENT_YEAR}</div>
                            <div class="legend-item"><div class="legend-dot lastyear"></div> ${PREVIOUS_YEAR}</div>
                            <div class="legend-item"><div class="legend-dot target"></div> Target</div>
                        </div>
                    </div>
                    <svg class="chart-svg" viewBox="0 0 ${width} ${height}">
                        ${yLabels}
                        ${xLabels}
                        ${targetPath ? `<path d="${targetPath}" fill="none" stroke="var(--positive)" stroke-width="2" stroke-dasharray="4,4"/>` : ''}
                        <path d="${lytdPath}" fill="none" stroke="var(--text-muted)" stroke-width="2" stroke-dasharray="5,5"/>
                        <path d="${ytdPath}" fill="none" stroke="var(--navy)" stroke-width="3"/>
                        ${dots}
                    </svg>
                </div>
            `;
        }

        function renderTrendPlaceholder() {
            return `
                <div class="trend-chart animate-fade-in">
                    <div class="trend-chart-header">
                        <div class="trend-chart-title">Monthly Trend</div>
                    </div>
                    <div class="insights-empty" style="padding: 80px;">
                        Trend data not available. Upload metrics_trend.csv for trend charts.
                    </div>
                </div>
            `;
        }

        // ============================================================================
        // EVENT HANDLERS
        // ============================================================================

        function attachEventListeners() {
            // Upload zone
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            const startBtn = document.getElementById('startBtn');
            const demoBtn = document.getElementById('demoBtn');

            if (uploadZone) {
                uploadZone.onclick = () => fileInput.click();
                uploadZone.ondragover = (e) => { e.preventDefault(); uploadZone.style.borderColor = 'var(--steel-blue)'; };
                uploadZone.ondragleave = () => { uploadZone.style.borderColor = ''; };
                uploadZone.ondrop = (e) => {
                    e.preventDefault();
                    uploadZone.style.borderColor = '';
                    const file = e.dataTransfer.files[0];
                    if (file && file.name.endsWith('.csv')) handleFileUpload(file);
                };
            }

            if (fileInput) {
                fileInput.onchange = (e) => { if (e.target.files[0]) handleFileUpload(e.target.files[0]); };
            }

            if (startBtn) {
                startBtn.onclick = () => {
                    if (state.museData) {
                        state.dataLoaded = true;
                        state.selectedMonth = getLatestMonth(state.museData);
                        render();
                    }
                };
            }

            if (demoBtn) {
                demoBtn.onclick = loadDemoData;
            }

            // Mode toggle
            document.querySelectorAll('.mode-toggle-btn').forEach(btn => {
                btn.onclick = () => {
                    state.dashboardMode = btn.dataset.mode;
                    state.activeTab = btn.dataset.mode === 'C-OVERVIEW' ? 'scorecard' : 'explorer';
                    render();
                };
            });

            // Tab clicks
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = () => {
                    if (btn.dataset.tab) {
                        state.activeTab = btn.dataset.tab;
                        render();
                    }
                };
            });

            // Filter selects
            const monthSelect = document.getElementById('monthSelect');
            if (monthSelect) {
                monthSelect.onchange = () => {
                    state.selectedMonth = monthSelect.value;
                    render();
                };
            }

            const marketSelect = document.getElementById('marketSelect');
            if (marketSelect) {
                marketSelect.onchange = () => {
                    state.selectedMarket = marketSelect.value;
                    render();
                };
            }

            const comparisonSelect = document.getElementById('comparisonSelect');
            if (comparisonSelect) {
                comparisonSelect.onchange = () => {
                    state.comparisonMode = comparisonSelect.value;
                    render();
                };
            }

            const kpiSelect = document.getElementById('kpiSelect');
            if (kpiSelect) {
                kpiSelect.onchange = () => {
                    state.selectedKPI = kpiSelect.value;
                    render();
                };
            }

            // Insights panel toggle
            const insightsHeader = document.getElementById('insightsHeader');
            if (insightsHeader) {
                insightsHeader.onclick = () => {
                    state.insightsPanelExpanded = !state.insightsPanelExpanded;
                    render();
                };
            }

            // Chart tooltips
            attachChartTooltips();
        }

        function attachChartTooltips() {
            const tooltip = document.getElementById('chartTooltip');
            const dots = document.querySelectorAll('.chart-dot');

            dots.forEach(dot => {
                dot.addEventListener('mouseenter', (e) => {
                    const info = JSON.parse(e.target.dataset.info);
                    tooltip.innerHTML = `
                        <div class="tooltip-title">${info.month}</div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">${CURRENT_YEAR}:</span>
                            <span class="tooltip-value">${formatValue(info.ytd, info.format)}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">${PREVIOUS_YEAR}:</span>
                            <span class="tooltip-value">${formatValue(info.lytd, info.format)}</span>
                        </div>
                        ${info.target ? `
                        <div class="tooltip-row">
                            <span class="tooltip-label">Target:</span>
                            <span class="tooltip-value">${formatValue(info.target, info.format)}</span>
                        </div>
                        ` : ''}
                    `;
                    tooltip.classList.add('visible');
                });

                dot.addEventListener('mousemove', (e) => {
                    tooltip.style.left = (e.clientX + 15) + 'px';
                    tooltip.style.top = (e.clientY - 10) + 'px';
                });

                dot.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('visible');
                });
            });
        }

        // ============================================================================
        // DATA LOADING
        // ============================================================================

        function handleFileUpload(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = parseCSV(e.target.result);
                    if (data.length > 0) {
                        state.museData = data;
                        state.museFileName = file.name;
                        render();
                    } else {
                        alert('Could not parse CSV. Please check the format.');
                    }
                } catch (err) {
                    console.error('Parse error:', err);
                    alert('Failed to parse file. Please check the format.');
                }
            };
            reader.readAsText(file);
        }

        function loadDemoData() {
            // Load main data
            fetch('data/metrics_main.csv')
                .then(r => r.text())
                .then(text => {
                    const data = parseCSV(text);
                    if (data.length > 0) {
                        state.museData = data;
                        state.museFileName = 'metrics_main.csv (demo)';
                        state.selectedMonth = getLatestMonth(data);
                        state.dataLoaded = true;

                        // Also try to load trend data
                        return fetch('data/metrics_trend.csv');
                    }
                    throw new Error('No data in main file');
                })
                .then(r => r.text())
                .then(text => {
                    const trendData = parseCSV(text);
                    if (trendData.length > 0) {
                        state.museTrendData = trendData;
                    }
                    render();
                })
                .catch(err => {
                    console.error('Demo load error:', err);
                    // Still render if main data loaded
                    if (state.museData) {
                        render();
                    } else {
                        alert('Could not load demo data. Please upload a file.');
                    }
                });
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        function init() {
            render();
        }

        document.addEventListener('DOMContentLoaded', init);

    })();
    </script>
</body>
</html>
